"use strict";(self.webpackChunkData_Design_AI_for_Urban_Data_and_Viz_Harvard_GSD=self.webpackChunkData_Design_AI_for_Urban_Data_and_Viz_Harvard_GSD||[]).push([[7200],{46228:function(e,t,i){i.d(t,{I:function(){return a},v:function(){return n}});var r=i(16889);function a(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=(0,r.uZ)(e,0,o),n=0;n<4;n++)t[i+n]=Math.floor(256*h(a*s[n]))}function n(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=0,r=0;r<4;r++)i+=e[t+r]*l[r];return i}var s=[1,256,65536,16777216],l=[1/256,1/65536,1/16777216,1/4294967296],o=n(new Uint8ClampedArray([255,255,255,255]));function h(e){return e-Math.floor(e)}},26554:function(e,t,i){i.d(t,{Y:function(){return l},m:function(){return o}});var r=i(37762),a=i(93433),n=i(46228),s=i(16889);function l(e,t,i){var r=(0,s.fp)(Math.ceil(i)),a=function(e){return"vertical"===e||"horizontal"===e||"cross"===e||"esriSFSCross"===e||"esriSFSVertical"===e||"esriSFSHorizontal"===e}(t)?8*r:16*r,n=2*r;e.width=a,e.height=a;var l=e.getContext("2d");l.strokeStyle="#FFFFFF",l.lineWidth=r,l.beginPath(),"vertical"!==t&&"cross"!==t&&"esriSFSCross"!==t&&"esriSFSVertical"!==t||(l.moveTo(a/2,-n),l.lineTo(a/2,a+n)),"horizontal"!==t&&"cross"!==t&&"esriSFSCross"!==t&&"esriSFSHorizontal"!==t||(l.moveTo(-n,a/2),l.lineTo(a+n,a/2)),"forward-diagonal"!==t&&"diagonal-cross"!==t&&"esriSFSDiagonalCross"!==t&&"esriSFSForwardDiagonal"!==t||(l.moveTo(-n,-n),l.lineTo(a+n,a+n),l.moveTo(a-n,-n),l.lineTo(a+n,n),l.moveTo(-n,a-n),l.lineTo(n,a+n)),"backward-diagonal"!==t&&"diagonal-cross"!==t&&"esriSFSBackwardDiagonal"!==t&&"esriSFSDiagonalCross"!==t||(l.moveTo(a+n,-n),l.lineTo(-n,a+n),l.moveTo(n,-n),l.lineTo(-n,n),l.moveTo(a+n,a-n),l.lineTo(a-n,a+n)),l.stroke();for(var o,h=l.getImageData(0,0,e.width,e.height),u=new Uint8Array(h.data),c=0;c<u.length;c+=4)o=u[c+3]/255,u[c]=u[c]*o,u[c+1]=u[c+1]*o,u[c+2]=u[c+2]*o;return[u,e.width,e.height]}function o(e,t){var i="Butt"===t,s="Square"===t,l=!i&&!s;e.length%2==1&&(e=[].concat((0,a.Z)(e),(0,a.Z)(e)));var o,h=15.5,u=0,c=(0,r.Z)(e);try{for(c.s();!(o=c.n()).done;){u+=o.value}}catch(D){c.e(D)}finally{c.f()}var f,y=Math.round(u*h),d=new Float32Array(31*y),v=7.75,p=0,_=0,g=.5,m=!0,b=(0,r.Z)(e);try{for(b.s();!(f=b.n()).done;){var x=f.value;for(p=_,_+=x*h;g<=_;){for(var w=.5;w<31;){var S=(w-.5)*y+g-.5,k=l?(w-h)*(w-h):Math.abs(w-h);d[S]=m?i?Math.max(Math.max(p+v-g,k),Math.max(g-_+v,k)):k:l?Math.min((g-p)*(g-p)+k,(g-_)*(g-_)+k):s?Math.min(Math.max(g-p,k),Math.max(_-g,k)):Math.min(Math.max(g-p+v,k),Math.max(_+v-g,k)),w++}g++}m=!m}}catch(D){b.e(D)}finally{b.f()}for(var C=d.length,Z=new Uint8Array(4*C),T=0;T<C;++T){var I=(l?Math.sqrt(d[T]):d[T])/h;(0,n.I)(I,Z,4*T)}return[Z,y,31]}},99201:function(e,t,i){i.d(t,{B1:function(){return r},DQ:function(){return h},DT:function(){return l},JJ:function(){return a},Or:function(){return u},_U:function(){return n},k3:function(){return c},sX:function(){return f}});var r=Number.POSITIVE_INFINITY,a=Math.PI,n=2*a,s=128/a,l=a/180,o=1/Math.LN2;function h(e,t){return(e%=t)>=0?e:e+t}function u(e){return h(e*s,256)}function c(e){return Math.log(e)*o}function f(e,t,i){return e*(1-i)+t*i}},60652:function(e,t,i){i.d(t,{E:function(){return s},V:function(){return r}});var r,a=i(15671),n=i(43144),s=function(){function e(t,i){(0,a.Z)(this,e),this.x=t,this.y=i}return(0,n.Z)(e,[{key:"clone",value:function(){return new e(this.x,this.y)}},{key:"equals",value:function(e,t){return e===this.x&&t===this.y}},{key:"isEqual",value:function(e){return e.x===this.x&&e.y===this.y}},{key:"setCoords",value:function(e,t){this.x=e,this.y=t}},{key:"normalize",value:function(){var e=this.x,t=this.y,i=Math.sqrt(e*e+t*t);this.x/=i,this.y/=i}},{key:"rightPerpendicular",value:function(){var e=this.x;this.x=this.y,this.y=-e}},{key:"move",value:function(e,t){this.x+=e,this.y+=t}},{key:"assign",value:function(e){this.x=e.x,this.y=e.y}},{key:"assignAdd",value:function(e,t){this.x=e.x+t.x,this.y=e.y+t.y}},{key:"assignSub",value:function(e,t){this.x=e.x-t.x,this.y=e.y-t.y}},{key:"rotate",value:function(e,t){var i=this.x,r=this.y;this.x=i*e-r*t,this.y=i*t+r*e}},{key:"scale",value:function(e){this.x*=e,this.y*=e}},{key:"length",value:function(){var e=this.x,t=this.y;return Math.sqrt(e*e+t*t)}}],[{key:"distance",value:function(e,t){var i=t.x-e.x,r=t.y-e.y;return Math.sqrt(i*i+r*r)}},{key:"add",value:function(t,i){return new e(t.x+i.x,t.y+i.y)}},{key:"sub",value:function(t,i){return new e(t.x-i.x,t.y-i.y)}}]),e}();!function(e){e[e.Unknown=0]="Unknown",e[e.Point=1]="Point",e[e.LineString=2]="LineString",e[e.Polygon=3]="Polygon"}(r||(r={}))},12233:function(e,t,i){i.d(t,{Z:function(){return n}});var r=i(15671),a=i(43144),n=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;(0,r.Z)(this,e),this.x=t,this.y=i,this.width=a,this.height=n}return(0,a.Z)(e,[{key:"isEmpty",get:function(){return this.width<=0||this.height<=0}},{key:"union",value:function(e){this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.width=Math.max(this.width,e.width),this.height=Math.max(this.height,e.height)}}]),e}()},55067:function(e,t,i){i.d(t,{Z:function(){return p}});var r=i(37762),a=i(15671),n=i(43144),s=i(11752),l=i(61120),o=i(60136),h=i(29388),u=i(93169),c=i(80613),f=i(64510),y=i(60418),d=i(40655),v=function(e,t){return e.key.level-t.key.level!=0?e.key.level-t.key.level:e.key.row-t.key.row!=0?e.key.row-t.key.row:e.key.col-t.key.col},p=function(e){(0,o.Z)(i,e);var t=(0,h.Z)(i);function i(e){var r;return(0,a.Z)(this,i),(r=t.call(this))._tileInfoView=e,r}return(0,n.Z)(i,[{key:"requiresDedicatedFBO",get:function(){return!1}},{key:"renderChildren",value:function(e){this.sortChildren(v),this.setStencilReference(e),(0,s.Z)((0,l.Z)(i.prototype),"renderChildren",this).call(this,e)}},{key:"createRenderParams",value:function(e){var t=e.state,r=(0,s.Z)((0,l.Z)(i.prototype),"createRenderParams",this).call(this,e);return r.requiredLevel=this._tileInfoView.getClosestInfoForScale(t.scale).level,r.displayLevel=this._tileInfoView.tileInfo.scaleToZoom(t.scale),r}},{key:"prepareRenderPasses",value:function(e){var t=this,r=(0,s.Z)((0,l.Z)(i.prototype),"prepareRenderPasses",this).call(this,e);return r.push(e.registerRenderPass({name:"stencil",brushes:[d.Z],drawPhase:c.jx.DEBUG|c.jx.MAP|c.jx.HIGHLIGHT,target:function(){return t.getStencilTarget()}})),(0,u.Z)("esri-tiles-debug")&&r.push(e.registerRenderPass({name:"tileInfo",brushes:[y.Z],drawPhase:c.jx.DEBUG,target:function(){return t.children}})),r}},{key:"getStencilTarget",value:function(){return this.children}},{key:"setStencilReference",value:function(e){var t,i=1,a=(0,r.Z)(this.children);try{for(a.s();!(t=a.n()).done;){t.value.stencilRef=i++}}catch(n){a.e(n)}finally{a.f()}}}]),i}(f.Z)},72900:function(e,t,i){i.d(t,{I:function(){return c}});var r=i(29439),a=i(15671),n=i(43144),s=i(60136),l=i(29388),o=i(22753),h=i(87422),u=i(73828),c=function(e){(0,s.Z)(i,e);var t=(0,l.Z)(i);function i(e,r,n,s,l,o){var h,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:l,f=arguments.length>7&&void 0!==arguments[7]?arguments[7]:o;return(0,a.Z)(this,i),(h=t.call(this)).triangleCountReportedInDebug=0,h.triangleCount=0,h.texture=null,h.key=new u.Z(e),h.resolution=r,h.x=n,h.y=s,h.width=l,h.height=o,h.rangeX=c,h.rangeY=f,h}return(0,n.Z)(i,[{key:"destroy",value:function(){this.texture&&(this.texture.dispose(),this.texture=null)}},{key:"setTransform",value:function(e){var t=this.resolution/(e.resolution*e.pixelRatio),i=this.transforms.tileMat3,a=e.toScreenNoRotation([0,0],[this.x,this.y]),n=(0,r.Z)(a,2),s=n[0],l=n[1],h=this.width/this.rangeX*t,u=this.height/this.rangeY*t;(0,o.s)(i,h,0,0,0,u,0,s,l,1),(0,o.m)(this.transforms.dvs,e.displayViewMat3,i)}}]),i}(h.s)},31907:function(e,t,i){i.r(t),i.d(t,{default:function(){return ze}});var r=i(74165),a=i(15861),n=i(29439),s=i(37762),l=i(15671),o=i(43144),h=i(11752),u=i(61120),c=i(60136),f=i(29388),y=i(27366),d=i(52639),v=i(84652),p=i(32718),_=i(92026),g=i(66978),m=i(94172),b=i(49861),x=(i(25243),i(69912)),w=i(48732),S=i(65156),k=i(92975),C=i(10106),Z=i(1413),T=i(35995),I=i(31009),D=i(12233),R=function(){function e(t,i){(0,l.Z)(this,e),this._width=0,this._height=0,this._free=[],this._width=t,this._height=i,this._free.push(new D.Z(0,0,t,i))}return(0,o.Z)(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"allocate",value:function(e,t){if(e>this._width||t>this._height)return new D.Z;for(var i=null,r=-1,a=0;a<this._free.length;++a){var n=this._free[a];e<=n.width&&t<=n.height&&(null===i||n.y<=i.y&&n.x<=i.x)&&(i=n,r=a)}return null===i?new D.Z:(this._free.splice(r,1),i.width<i.height?(i.width>e&&this._free.push(new D.Z(i.x+e,i.y,i.width-e,t)),i.height>t&&this._free.push(new D.Z(i.x,i.y+t,i.width,i.height-t))):(i.width>e&&this._free.push(new D.Z(i.x+e,i.y,i.width-e,i.height)),i.height>t&&this._free.push(new D.Z(i.x,i.y+t,e,i.height-t))),new D.Z(i.x,i.y,e,t))}},{key:"release",value:function(e){for(var t=0;t<this._free.length;++t){var i=this._free[t];if(i.y===e.y&&i.height===e.height&&i.x+i.width===e.x)i.width+=e.width;else if(i.x===e.x&&i.width===e.width&&i.y+i.height===e.y)i.height+=e.height;else if(e.y===i.y&&e.height===i.height&&e.x+e.width===i.x)i.x=e.x,i.width+=e.width;else{if(e.x!==i.x||e.width!==i.width||e.y+e.height!==i.y)continue;i.y=e.y,i.height+=e.height}this._free.splice(t,1),this.release(e)}this._free.push(e)}}]),e}(),P=i(8548),A=i(51378),M=function(){function e(t,i,r){(0,l.Z)(this,e),this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphIndex={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=i,this._glyphSource=r,this._binPack=new R(t-4,i-4),this._glyphData.push(new Uint8Array(t*i)),this._dirties.push(!0),this._textures.push(void 0)}return(0,o.Z)(e,[{key:"getGlyphItems",value:function(e,t){var i,r=this,a=[],n=this._glyphSource,l=new Set,o=(0,s.Z)(t);try{for(o.s();!(i=o.n()).done;){var h=i.value,u=Math.floor(.00390625*h);l.add(u)}}catch(f){o.e(f)}finally{o.f()}var c=[];return l.forEach((function(t){if(t<=256){var i=e+t;if(r._rangePromises.has(i))c.push(r._rangePromises.get(i));else{var a=n.getRange(e,t).then((function(){r._rangePromises.delete(i)}),(function(){r._rangePromises.delete(i)}));r._rangePromises.set(i,a),c.push(a)}}})),Promise.all(c).then((function(){var i=r._glyphIndex[e];i||(i={},r._glyphIndex[e]=i);var l,o=(0,s.Z)(t);try{for(o.s();!(l=o.n()).done;){var h=l.value,u=i[h];if(u)a[h]={sdf:!0,rect:u.rect,metrics:u.metrics,page:u.page,code:h};else{var c=n.getGlyph(e,h);if(c&&c.metrics){var y=c.metrics,d=void 0;if(0===y.width)d=new D.Z(0,0,0,0);else{var v=y.width+6,p=y.height+6,_=v%4?4-v%4:4,g=p%4?4-p%4:4;1===_&&(_=5),1===g&&(g=5),(d=r._binPack.allocate(v+_,p+g)).isEmpty&&(r._dirties[r._currentPage]||(r._glyphData[r._currentPage]=null),r._currentPage=r._glyphData.length,r._glyphData.push(new Uint8Array(r.width*r.height)),r._dirties.push(!0),r._textures.push(void 0),r._binPack=new R(r.width-4,r.height-4),d=r._binPack.allocate(v+_,p+g));var m=r._glyphData[r._currentPage],b=c.bitmap,x=void 0,w=void 0;if(b)for(var S=0;S<p;S++){x=v*S,w=r.width*(d.y+S+1)+d.x;for(var k=0;k<v;k++)m[w+k+1]=b[x+k]}}i[h]={rect:d,metrics:y,tileIDs:null,page:r._currentPage},a[h]={sdf:!0,rect:d,metrics:y,page:r._currentPage,code:h},r._dirties[r._currentPage]=!0}}}}catch(f){o.e(f)}finally{o.f()}return a}))}},{key:"removeGlyphs",value:function(e){for(var t in this._glyphIndex){var i=this._glyphIndex[t];if(i){var r=void 0;for(var a in i)if((r=i[a]).tileIDs.delete(e),0===r.tileIDs.size){for(var n=this._glyphData[r.page],s=r.rect,l=void 0,o=void 0,h=0;h<s.height;h++)for(l=this.width*(s.y+h)+s.x,o=0;o<s.width;o++)n[l+o]=0;delete i[a],this._dirties[r.page]=!0}}}}},{key:"bind",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;this._textures[i]||(this._textures[i]=new A.x(e,{pixelFormat:P.VI.ALPHA,dataType:P.Br.UNSIGNED_BYTE,width:this.width,height:this.height},new Uint8Array(this.width*this.height)));var a=this._textures[i];a.setSamplingMode(t),this._dirties[i]&&a.setData(this._glyphData[i]),e.bindTexture(a,r),this._dirties[i]=!1}},{key:"dispose",value:function(){this._binPack=null;var e,t=(0,s.Z)(this._textures);try{for(t.s();!(e=t.n()).done;){var i=e.value;i&&i.dispose()}}catch(r){t.e(r)}finally{t.f()}this._textures.length=0}}]),e}(),L=i(76200),B=i(78084),O=function(){function e(t){if((0,l.Z)(this,e),this._metrics=[],this._bitmaps=[],t)for(;t.next();)if(1===t.tag()){for(var i=t.getMessage();i.next();)if(3===i.tag()){for(var r=i.getMessage(),a=void 0,n=void 0,s=void 0,o=void 0,h=void 0,u=void 0,c=void 0;r.next();)switch(r.tag()){case 1:a=r.getUInt32();break;case 2:n=r.getBytes();break;case 3:s=r.getUInt32();break;case 4:o=r.getUInt32();break;case 5:h=r.getSInt32();break;case 6:u=r.getSInt32();break;case 7:c=r.getUInt32();break;default:r.skip()}r.release(),a&&(this._metrics[a]={width:s,height:o,left:h,top:u,advance:c},this._bitmaps[a]=n)}else i.skip();i.release()}else t.skip()}return(0,o.Z)(e,[{key:"getMetrics",value:function(e){return this._metrics[e]}},{key:"getBitmap",value:function(e){return this._bitmaps[e]}}]),e}(),U=function(){function e(){(0,l.Z)(this,e),this._ranges=[]}return(0,o.Z)(e,[{key:"getRange",value:function(e){return this._ranges[e]}},{key:"addRange",value:function(e,t){this._ranges[e]=t}}]),e}(),V=function(){function e(t){(0,l.Z)(this,e),this._glyphInfo={},this._baseURL=t}return(0,o.Z)(e,[{key:"getRange",value:function(e,t){var i=this._getFontStack(e);if(i.getRange(t))return Promise.resolve();var r=256*t,a=r+255;if(this._baseURL){var n=this._baseURL.replace("{fontstack}",e).replace("{range}",r+"-"+a);return(0,L.default)(n,{responseType:"array-buffer"}).then((function(e){i.addRange(t,new O(new B.Z(new Uint8Array(e.data),new DataView(e.data))))})).catch((function(){i.addRange(t,new O)}))}return i.addRange(t,new O),Promise.resolve()}},{key:"getGlyph",value:function(e,t){var i=this._getFontStack(e);if(i){var r=Math.floor(t/256);if(!(r>256)){var a=i.getRange(r);return a?{metrics:a.getMetrics(t),bitmap:a.getBitmap(t)}:void 0}}}},{key:"_getFontStack",value:function(e){var t=this._glyphInfo[e];return t||(t=this._glyphInfo[e]=new U),t}}]),e}(),F=i(26554),E="dasharray-",z=function(){function e(t,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;(0,l.Z)(this,e),this._size=[],this._mosaicsData=[],this._textures=[],this._dirties=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects={},this.pixelRatio=1,(t<=0||i<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=i,r>0&&(this._maxItemSize=r),this._binPack=new R(t-4,i-4)}return(0,o.Z)(e,[{key:"dispose",value:function(){this._binPack=null,this._mosaicRects={};var e,t=(0,s.Z)(this._textures);try{for(t.s();!(e=t.n()).done;){var i=e.value;i&&i.dispose()}}catch(r){t.e(r)}finally{t.f()}this._textures.length=0}},{key:"getWidth",value:function(e){return e>=this._size.length?-1:this._size[e][0]}},{key:"getHeight",value:function(e){return e>=this._size.length?-1:this._size[e][1]}},{key:"getPageSize",value:function(e){return e>=this._size.length?null:this._size[e]}},{key:"setSpriteSource",value:function(e){if(this.dispose(),this.pixelRatio=e.devicePixelRatio,0===this._mosaicsData.length){this._binPack=new R(this._pageWidth-4,this._pageHeight-4);var t=Math.floor(this._pageWidth),i=Math.floor(this._pageHeight),r=new Uint32Array(t*i);this._mosaicsData[0]=r,this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0)}this._sprites=e}},{key:"getSpriteItem",value:function(e){var t,i,r,a,s=arguments.length>1&&void 0!==arguments[1]&&arguments[1],l=this._mosaicRects[e];if(l)return l;if(!this._sprites||"loaded"!==this._sprites.loadStatus)return null;if(e&&e.startsWith(E)?(t=this._rasterizeDash(e),r=(i=(0,n.Z)(t,2))[0],a=i[1],s=!0):r=this._sprites.getSpriteInfo(e),!r||!r.width||!r.height||r.width<0||r.height<0)return null;var o=r.width,h=r.height,u=this._allocateImage(o,h),c=(0,n.Z)(u,3),f=c[0],y=c[1],d=c[2];return f.width<=0?null:(this._copy(f,r,y,d,s,a),l={rect:f,width:o,height:h,sdf:r.sdf,simplePattern:!1,pixelRatio:r.pixelRatio,page:y},this._mosaicRects[e]=l,l)}},{key:"getSpriteItems",value:function(e){var t,i={},r=(0,s.Z)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value;i[a.name]=this.getSpriteItem(a.name,a.repeat)}}catch(n){r.e(n)}finally{r.f()}return i}},{key:"getMosaicItemPosition",value:function(e,t){var i=this.getSpriteItem(e,t),r=i&&i.rect;if(!r)return null;r.width=i.width,r.height=i.height;var a=i.width,n=i.height;return{tl:[r.x+2,r.y+2],br:[r.x+2+a,r.y+2+n],page:i.page}}},{key:"bind",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(!(i>=this._size.length||i>=this._mosaicsData.length)){this._textures[i]||(this._textures[i]=new A.x(e,{pixelFormat:P.VI.RGBA,dataType:P.Br.UNSIGNED_BYTE,wrapMode:P.e8.CLAMP_TO_EDGE,width:this._size[i][0],height:this._size[i][1]},new Uint8Array(this._mosaicsData[i].buffer)));var a=this._textures[i];a.setSamplingMode(t),this._dirties[i]&&a.setData(new Uint8Array(this._mosaicsData[i].buffer)),e.bindTexture(a,r),this._dirties[i]=!1}}},{key:"_copy",value:function(t,i,r,a,n,s){if(this._sprites&&"loaded"===this._sprites.loadStatus&&!(r>=this._mosaicsData.length)){var l=new Uint32Array(s?s.buffer:this._sprites.image.buffer),o=this._mosaicsData[r];o&&l||console.error("Source or target images are uninitialized!");var h=s?i.width:this._sprites.width;e._copyBits(l,h,i.x,i.y,o,a[0],t.x+2,t.y+2,i.width,i.height,n),this._dirties[r]=!0}}},{key:"_allocateImage",value:function(e,t){e+=2,t+=2;var i=Math.max(e,t);if(this._maxItemSize&&this._maxItemSize<i){var r=new D.Z(0,0,e,t);return this._mosaicsData.push(new Uint32Array(e*t)),this._dirties.push(!0),this._size.push([e,t]),this._textures.push(void 0),[r,this._mosaicsData.length-1,[e,t]]}var a=e%4?4-e%4:4,n=t%4?4-t%4:4;1===a&&(a=5),1===n&&(n=5);var s=this._binPack.allocate(e+a,t+n);return s.width<=0?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new R(this._pageWidth-4,this._pageHeight-4),this._allocateImage(e,t)):[s,this._currentPage,[this._pageWidth,this._pageHeight]]}},{key:"_rasterizeDash",value:function(e){var t=e.match(/\[(.*?)\]/);if(!t)return null;var i=t[1].split(",").map(Number),r=e.slice(e.lastIndexOf("-")+1),a=(0,F.m)(i,r),s=(0,n.Z)(a,3),l=s[0];return[{x:0,y:0,width:s[1],height:s[2],sdf:!0,pixelRatio:1},new Uint8Array(l.buffer)]}}],[{key:"_copyBits",value:function(e,t,i,r,a,n,s,l,o,h,u){var c=r*t+i,f=l*n+s;if(u){f-=n;for(var y=-1;y<=h;c=((++y+h)%h+r)*t+i,f+=n)for(var d=-1;d<=o;d++)a[f+d]=e[c+(d+o)%o]}else for(var v=0;v<h;v++){for(var p=0;p<o;p++)a[f+p]=e[c+p];c+=t,f+=n}}}]),e}(),H=i(73828),q=function(){function e(t,i,r){(0,l.Z)(this,e),this._layer=t,this._styleRepository=i,this.devicePixelRatio=r,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null}return(0,o.Z)(e,[{key:"destroy",value:function(){this._connection&&(this._connection.close(),this._connection=null),this._styleRepository=null,this._layer=null,this._spriteMosaic&&(this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic=null)}},{key:"spriteMosaic",get:function(){var e=this;return this._spriteSourcePromise.then((function(){return e._spriteMosaic}))}},{key:"glyphMosaic",get:function(){return this._glyphMosaic}},{key:"start",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t){var i,a=this;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,t),this._spriteSourcePromise.then((function(e){a._spriteMosaic=new z(1024,1024,250),a._spriteMosaic.setSpriteSource(e)})),i=new V(this._layer.currentStyleInfo.glyphsUrl?(0,T.fl)(this._layer.currentStyleInfo.glyphsUrl,(0,Z.Z)((0,Z.Z)({},this._layer.customParameters),{},{token:this._layer.apiKey})):null),this._glyphMosaic=new M(1024,1024,i),this._broadcastPromise=(0,I.bA)("WorkerTileHandler",{client:this,schedule:t.schedule,signal:t.signal}).then((function(e){if(a._connection=e,a._layer&&!a._connection.closed){var i=e.broadcast("setStyle",a._layer.currentStyleInfo.style,t);Promise.all(i).catch((function(e){return(0,g.H9)(e)}))}}));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"updateStyle",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t){return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._broadcastPromise;case 2:return this._broadcastPromise=Promise.all(this._connection.broadcast("updateStyle",t)),e.abrupt("return",this._broadcastPromise);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"setSpriteSource",value:function(e){var t=new z(1024,1024,250);return t.setSpriteSource(e),this._spriteMosaic=t,this._spriteSourcePromise=Promise.resolve(e),t}},{key:"setStyle",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t,i){var a,n=this;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._broadcastPromise;case 2:return this._styleRepository=t,this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,null),this._spriteSourcePromise.then((function(e){n._spriteMosaic=new z(1024,1024,250),n._spriteMosaic.setSpriteSource(e)})),a=new V(this._layer.currentStyleInfo.glyphsUrl?(0,T.fl)(this._layer.currentStyleInfo.glyphsUrl,(0,Z.Z)((0,Z.Z)({},this._layer.customParameters),{},{token:this._layer.apiKey})):null),e.abrupt("return",(this._glyphMosaic=new M(1024,1024,a),this._broadcastPromise=Promise.all(this._connection.broadcast("setStyle",i)),this._broadcastPromise));case 7:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"fetchTileData",value:function(e,t){var i=this;return this._getRefKeys(e,t).then((function(e){var r=i._layer.sourceNameToSource,a=[];for(var n in r)a.push(n);return i._getSourcesData(a,e,t)}))}},{key:"parseTileData",value:function(e,t){var i=this,r=e&&e.data;if(!r)return Promise.resolve(null);var a=r.sourceName2DataAndRefKey,n=r.transferList;return 0===Object.keys(a).length?Promise.resolve(null):this._broadcastPromise.then((function(){return i._connection.invoke("createTileAndParse",{key:e.key.id,sourceName2DataAndRefKey:a,styleLayerUIDs:e.styleLayerUIDs},(0,Z.Z)((0,Z.Z)({},t),{},{transferList:n}))}))}},{key:"getSprites",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t){return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._spriteSourcePromise;case 2:return e.abrupt("return",this._spriteMosaic.getSpriteItems(t));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getGlyphs",value:function(e){return this._glyphMosaic.getGlyphItems(e.font,e.codePoints)}},{key:"_getTilePayload",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t,i,a){var n,s,l,o,h;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=H.Z.pool.acquire(t.id),s=this._layer.sourceNameToSource[i],l=n.level,o=n.row,h=n.col,H.Z.pool.release(n),e.prev=2,e.next=5,s.requestTile(l,o,h,a);case 5:return e.t0=e.sent,e.t1=i,e.abrupt("return",{protobuff:e.t0,sourceName:e.t1});case 10:if(e.prev=10,e.t2=e.catch(2),!(0,g.D_)(e.t2)){e.next=14;break}throw e.t2;case 14:return e.abrupt("return",{protobuff:null,sourceName:i});case 15:case"end":return e.stop()}}),e,this,[[2,10]])})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_getRefKeys",value:function(e,t){var i=this._layer.sourceNameToSource,r=new Array;for(var a in i){var n=i[a].getRefKey(e,t);r.push(n)}return(0,g.as)(r)}},{key:"_getSourcesData",value:function(e,t,i){for(var r=[],a=0;a<t.length;a++)if(null==t[a].value||null==e[a])r.push(null);else{var n=this._getTilePayload(t[a].value,e[a],i);r.push(n)}return(0,g.as)(r).then((function(e){for(var i={},r=[],a=0;a<e.length;a++)if(e[a].value&&e[a].value&&e[a].value.protobuff&&e[a].value.protobuff.byteLength>0){var n=t[a].value.id;i[e[a].value.sourceName]={refKey:n,protobuff:e[a].value.protobuff},r.push(e[a].value.protobuff)}return{sourceName2DataAndRefKey:i,transferList:r}}))}}]),e}(),N=i(16054),W=i(48790),j=function(e,t){return e+1/(1<<2*t)},Q=function(){function e(t,i){(0,l.Z)(this,e),this._tiles=new Map,this._tileCache=new N.Z(40,(function(e){return e.dispose()})),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,this._container=i}return(0,o.Z)(e,[{key:"destroy",value:function(){var e,t=(0,s.Z)(this._tiles);try{for(t.s();!(e=t.n()).done;){var i=(0,n.Z)(e.value,2);i[0];i[1].dispose()}}catch(r){t.e(r)}finally{t.f()}this._tiles=null,this._tileCache.clear(),this._tileCache=null}},{key:"update",value:function(e){this._updateCacheSize(e);var t,i=this.tileInfoView,r=i.getTileCoverage(e.state,0,"smallest"),a=r.spans,l=r.lodInfo,o=l.level,h=this._tiles,u=new Set,c=new Set,f=(0,s.Z)(a);try{for(f.s();!(t=f.n()).done;)for(var y=t.value,d=y.row,v=y.colFrom,p=y.colTo,_=v;_<=p;_++){var g=H.Z.getId(o,d,l.normalizeCol(_),l.getWorldForColumn(_)),m=this._getOrAcquireTile(g);u.add(g),m.processed()?this._addToContainer(m):c.add(new H.Z(g))}}catch(U){f.e(U)}finally{f.f()}var b,x=(0,s.Z)(h);try{for(x.s();!(b=x.n()).done;){var w=(0,n.Z)(b.value,2),S=w[0];w[1].isCoverage=u.has(S)}}catch(U){x.e(U)}finally{x.f()}var k,C=(0,s.Z)(c);try{for(C.s();!(k=C.n()).done;){var Z=k.value;this._findPlaceholdersForMissingTiles(Z,u)}}catch(U){C.e(U)}finally{C.f()}var T,I=!1,D=(0,s.Z)(h);try{for(D.s();!(T=D.n()).done;){var R=(0,n.Z)(T.value,2),P=R[0],A=R[1];A.neededForCoverage=u.has(P),A.neededForCoverage||A.isHoldingForFade&&i.intersects(r,A.key)&&u.add(P),A.isFading&&(I=!0)}}catch(U){D.e(U)}finally{D.f()}var M,L=(0,s.Z)(this._tiles);try{for(L.s();!(M=L.n()).done;){var B=(0,n.Z)(M.value,2),O=B[0];B[1];u.has(O)||this._releaseTile(O)}}catch(U){L.e(U)}finally{L.f()}return W.Z.pool.release(r),!I}},{key:"clear",value:function(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}},{key:"clearCache",value:function(){this._tileCache.clear()}},{key:"_findPlaceholdersForMissingTiles",value:function(e,t){var i,r=[],a=(0,s.Z)(this._tiles);try{for(a.s();!(i=a.n()).done;){var l=(0,n.Z)(i.value,2),o=(l[0],l[1]);this._addPlaceholderChild(r,o,e,t)}}catch(u){a.e(u)}finally{a.f()}var h=r.reduce(j,0);Math.abs(1-h)<1e-6||this._addPlaceholderParent(e.id,t)}},{key:"_addPlaceholderChild",value:function(e,t,i,r){t.key.level<=i.level||!t.hasData()||function(e,t){var i=t.level-e.level;return e.row===t.row>>i&&e.col===t.col>>i&&e.world===t.world}(i,t.key)&&(this._addToContainer(t),r.add(t.id),e.push(t.key.level-i.level))}},{key:"_addPlaceholderParent",value:function(e,t){for(var i=this._tiles,r=e;;){if(!(r=J(r))||t.has(r))return;var a=i.get(r);if(a&&a.hasData())return this._addToContainer(a),void t.add(a.id)}}},{key:"_getOrAcquireTile",value:function(e){var t=this._tiles.get(e);return t||((t=this._tileCache.pop(e))||(t=this.acquireTile(new H.Z(e))),this._tiles.set(e,t),t)}},{key:"_releaseTile",value:function(e){var t=this._tiles.get(e);this.releaseTile(t),this._removeFromContainer(t),this._tiles.delete(e),t.hasData()?this._tileCache.put(e,t,1):t.dispose()}},{key:"_addToContainer",value:function(e){var t,i=[],r=this._container;if(!r.contains(e)){var a,l=this._visibleTiles,o=(0,s.Z)(l);try{for(o.s();!(a=o.n()).done;){var h=(0,n.Z)(a.value,2),u=(h[0],h[1]);this._canConnectDirectly(e,u)&&i.push(u),(0,_.Wi)(t)&&this._canConnectDirectly(u,e)&&(t=u)}}catch(g){o.e(g)}finally{o.f()}if((0,_.pC)(t)){var c,f=(0,s.Z)(i);try{for(f.s();!(c=f.n()).done;){var y=c.value;t.childrenTiles.delete(y),e.childrenTiles.add(y),y.parentTile=e}}catch(g){f.e(g)}finally{f.f()}t.childrenTiles.add(e),e.parentTile=t}else{var d,v=(0,s.Z)(i);try{for(v.s();!(d=v.n()).done;){var p=d.value;e.childrenTiles.add(p),p.parentTile=e}}catch(g){v.e(g)}finally{v.f()}}l.set(e.id,e),r.addChild(e)}}},{key:"_removeFromContainer",value:function(e){if(this._visibleTiles.delete(e.id),this._container.removeChild(e),(0,_.pC)(e.parentTile)){e.parentTile.childrenTiles.delete(e);var t,i=(0,s.Z)(e.childrenTiles);try{for(i.s();!(t=i.n()).done;){var r=t.value;(0,_.pC)(e.parentTile)&&e.parentTile.childrenTiles.add(r)}}catch(l){i.e(l)}finally{i.f()}}var a,n=(0,s.Z)(e.childrenTiles);try{for(n.s();!(a=n.n()).done;){a.value.parentTile=e.parentTile}}catch(l){n.e(l)}finally{n.f()}e.parentTile=null,e.childrenTiles.clear()}},{key:"_canConnectDirectly",value:function(e,t){for(var i=e.key,r=t.key,a=r.level,n=r.row,s=r.col,l=r.world,o=this._visibleTiles;a>0;){if(a--,n>>=1,s>>=1,i.level===a&&i.row===n&&i.col===s&&i.world===l)return!0;if(o.has("".concat(a,"/").concat(n,"/").concat(s,"/").concat(l)))return!1}return!1}},{key:"_updateCacheSize",value:function(e){var t=e.state.size;if(t[0]!==this._viewSize[0]||t[1]!==this._viewSize[1]){var i=Math.ceil(t[0]/512)+1,r=Math.ceil(t[1]/512)+1;this._viewSize[0]=t[0],this._viewSize[1]=t[1],this._tileCache.maxSize=5*i*r}}}]),e}();function J(e){var t=e.split("/"),i=(0,n.Z)(t,4),r=i[0],a=i[1],s=i[2],l=i[3],o=parseInt(r,10);return 0===o?null:"".concat(o-1,"/").concat(parseInt(a,10)>>1,"/").concat(parseInt(s,10)>>1,"/").concat(parseInt(l,10))}var G=i(22753),Y=i(23588),K=(0,o.Z)((function e(t){(0,l.Z)(this,e),this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=t})),X=(0,o.Z)((function e(){(0,l.Z)(this,e),this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}));function $(e,t,i,r,a,n){var s=i-a;if(s>=0)return(t>>s)+(r-(n<<s))*(e>>s);var l=-s;return t-(n-(r<<l))*(e>>l)<<l}var ee=function(){function e(t,i,r){(0,l.Z)(this,e),this._rows=Math.ceil(i/r),this._columns=Math.ceil(t/r),this._cellSize=r,this.cells=new Array(this._rows);for(var a=0;a<this._rows;a++){this.cells[a]=new Array(this._columns);for(var n=0;n<this._columns;n++)this.cells[a][n]=[]}}return(0,o.Z)(e,[{key:"getCell",value:function(e,t){var i=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._rows-1),r=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[i]&&this.cells[i][r]||null}},{key:"getCellSpan",value:function(e,t,i,r){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.rows-1)]}},{key:"cellSize",get:function(){return this._cellSize}},{key:"columns",get:function(){return this._columns}},{key:"rows",get:function(){return this._rows}}]),e}();function te(e,t,i,r,a){var l=e.layerData.get(a);if(l.type===C.al.SYMBOL){var o,h=(0,s.Z)(r);try{for(h.s();!(o=h.n()).done;){var u=o.value,c=u.unique,f=void 0;if(u.selectedForRendering){var y=c.parts[0],d=y.startOpacity,v=y.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===v;var p=i?Math.floor(127*d)|v<<7:v?255:0;f=p<<24|p<<16|p<<8|p}else f=0;var _,g=(0,s.Z)(u.iconVertexRanges);try{for(g.s();!(_=g.n()).done;)for(var m=(0,n.Z)(_.value,2),b=m[0],x=m[1],w=b;w<b+x;w+=4)l.iconOpacity[w/4]=f}catch(L){g.e(L)}finally{g.f()}if(u.selectedForRendering){var S=c.parts[1],k=S.startOpacity,Z=S.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===Z;var T=i?Math.floor(127*k)|Z<<7:Z?255:0;f=T<<24|T<<16|T<<8|T}else f=0;var I,D=(0,s.Z)(u.textVertexRanges);try{for(D.s();!(I=D.n()).done;)for(var R=(0,n.Z)(I.value,2),P=R[0],A=R[1],M=P;M<P+A;M+=4)l.textOpacity[M/4]=f}catch(L){D.e(L)}finally{D.f()}}}catch(L){h.e(L)}finally{h.f()}l.lastOpacityUpdate=t,l.opacityChanged=!0}}var ie=i(44070),re=i(45412),ae=function(){function e(t,i){(0,l.Z)(this,e),this.layerUIDs=[],this.isDestroyed=!1,this._data=t,this.memoryUsed=t.byteLength;var r=1,a=new Uint32Array(t);this.layerUIDs=[];for(var n=a[r++],s=0;s<n;s++)this.layerUIDs[s]=a[r++];this.bufferDataOffset=r,i&&(this.layer=i.getStyleLayerByUID(this.layerUIDs[0]))}return(0,o.Z)(e,[{key:"isPreparedForRendering",get:function(){return(0,_.Wi)(this._data)}},{key:"offset",get:function(){return this.bufferDataOffset}},{key:"destroy",value:function(){this.isDestroyed||(this.doDestroy(),this.isDestroyed=!0)}},{key:"prepareForRendering",value:function(e){(0,_.Wi)(this._data)||(this.doPrepareForRendering(e,this._data,this.bufferDataOffset),this._data=null)}}]),e}(),ne=function(e){(0,c.Z)(i,e);var t=(0,f.Z)(i);function i(e,r){var a;(0,l.Z)(this,i),(a=t.call(this,e,r)).type=C.al.LINE,a.lineIndexStart=0,a.lineIndexCount=0;var n=new Uint32Array(e),s=a.bufferDataOffset;a.lineIndexStart=n[s++],a.lineIndexCount=n[s++];var o=n[s++];if(o>0){for(var h=new Map,u=0;u<o;u++){var c=n[s++],f=n[s++],y=n[s++];h.set(c,[f,y])}a.patternMap=h}return a.bufferDataOffset=s,a}return(0,o.Z)(i,[{key:"hasData",value:function(){return this.lineIndexCount>0}},{key:"triangleCount",value:function(){return this.lineIndexCount/3}},{key:"doDestroy",value:function(){(0,_.pC)(this.lineVertexArrayObject)&&this.lineVertexArrayObject.dispose(),(0,_.pC)(this.lineVertexBuffer)&&this.lineVertexBuffer.dispose(),(0,_.pC)(this.lineIndexBuffer)&&this.lineIndexBuffer.dispose(),this.lineVertexArrayObject=null,this.lineVertexBuffer=null,this.lineIndexBuffer=null,this.memoryUsed=0}},{key:"doPrepareForRendering",value:function(e,t,i){var r=new Uint32Array(t),a=new Int32Array(r.buffer),n=r[i++];this.lineVertexBuffer=ie.f.createVertex(e,P.l1.STATIC_DRAW,new Int32Array(a.buffer,4*i,n)),i+=n;var s=r[i++];this.lineIndexBuffer=ie.f.createIndex(e,P.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*i,s)),i+=s;var l=this.layer.lineMaterial;this.lineVertexArrayObject=new re.U(e,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:this.lineVertexBuffer},this.lineIndexBuffer)}}]),i}(ae),se=function(e){(0,c.Z)(i,e);var t=(0,f.Z)(i);function i(e,r){var a;(0,l.Z)(this,i),(a=t.call(this,e,r)).type=C.al.FILL,a.fillIndexStart=0,a.fillIndexCount=0,a.outlineIndexStart=0,a.outlineIndexCount=0;var n=new Uint32Array(e),s=a.bufferDataOffset;a.fillIndexStart=n[s++],a.fillIndexCount=n[s++],a.outlineIndexStart=n[s++],a.outlineIndexCount=n[s++];var o=n[s++];if(o>0){for(var h=new Map,u=0;u<o;u++){var c=n[s++],f=n[s++],y=n[s++];h.set(c,[f,y])}a.patternMap=h}return a.bufferDataOffset=s,a}return(0,o.Z)(i,[{key:"hasData",value:function(){return this.fillIndexCount>0||this.outlineIndexCount>0}},{key:"triangleCount",value:function(){return(this.fillIndexCount+this.outlineIndexCount)/3}},{key:"doDestroy",value:function(){(0,_.pC)(this.fillVertexArrayObject)&&this.fillVertexArrayObject.dispose(),(0,_.pC)(this.fillVertexBuffer)&&this.fillVertexBuffer.dispose(),(0,_.pC)(this.fillIndexBuffer)&&this.fillIndexBuffer.dispose(),this.fillVertexArrayObject=null,this.fillVertexBuffer=null,this.fillIndexBuffer=null,(0,_.pC)(this.outlineVertexArrayObject)&&this.outlineVertexArrayObject.dispose(),(0,_.pC)(this.outlineVertexBuffer)&&this.outlineVertexBuffer.dispose(),(0,_.pC)(this.outlineIndexBuffer)&&this.outlineIndexBuffer.dispose(),this.outlineVertexArrayObject=null,this.outlineVertexBuffer=null,this.outlineIndexBuffer=null,this.memoryUsed=0}},{key:"doPrepareForRendering",value:function(e,t,i){var r=new Uint32Array(t),a=new Int32Array(r.buffer),n=r[i++];this.fillVertexBuffer=ie.f.createVertex(e,P.l1.STATIC_DRAW,new Int32Array(a.buffer,4*i,n)),i+=n;var s=r[i++];this.fillIndexBuffer=ie.f.createIndex(e,P.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*i,s)),i+=s;var l=r[i++];this.outlineVertexBuffer=ie.f.createVertex(e,P.l1.STATIC_DRAW,new Int32Array(a.buffer,4*i,l)),i+=l;var o=r[i++];this.outlineIndexBuffer=ie.f.createIndex(e,P.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*i,o)),i+=o;var h=this.layer,u=h.fillMaterial,c=h.outlineMaterial;this.fillVertexArrayObject=new re.U(e,u.getAttributeLocations(),u.getLayoutInfo(),{geometry:this.fillVertexBuffer},this.fillIndexBuffer),this.outlineVertexArrayObject=new re.U(e,c.getAttributeLocations(),c.getLayoutInfo(),{geometry:this.outlineVertexBuffer},this.outlineIndexBuffer)}}]),i}(ae),le=function(e){(0,c.Z)(i,e);var t=(0,f.Z)(i);function i(e,r,a){var n;(0,l.Z)(this,i),(n=t.call(this,e,r)).type=C.al.SYMBOL,n.iconPerPageElementsMap=new Map,n.glyphPerPageElementsMap=new Map,n.symbolInstances=[],n.isIconSDF=!1,n.opacityChanged=!1,n.lastOpacityUpdate=0,n.symbols=[];var s=new Uint32Array(e),o=new Int32Array(e),h=new Float32Array(e),u=n.bufferDataOffset;n.isIconSDF=!!s[u++];for(var c=s[u++],f=0;f<c;f++){var y=s[u++],d=s[u++],v=s[u++];n.iconPerPageElementsMap.set(y,[d,v])}for(var p=s[u++],_=0;_<p;_++){var g=s[u++],m=s[u++],b=s[u++];n.glyphPerPageElementsMap.set(g,[m,b])}var x=s[u++],w=s[u++];return n.iconOpacity=new Int32Array(x),n.textOpacity=new Int32Array(w),u=function(e,t,i,r,a,n){for(var s=t[r++],l=0;l<s;l++){var o=new K(n);o.xTile=t[r++],o.yTile=t[r++],o.hash=t[r++],o.priority=t[r++];for(var h=t[r++],u=0;u<h;u++){var c=t[r++],f=t[r++],y=t[r++],d=t[r++],v=!!t[r++],p=t[r++],_=i[r++],g=i[r++],m=t[r++],b=t[r++];o.colliders.push({xTile:c,yTile:f,dxPixels:y,dyPixels:d,hard:v,partIndex:p,width:m,height:b,minLod:_,maxLod:g})}for(var x=e[r++],w=0;w<x;w++)o.textVertexRanges.push([e[r++],e[r++]]);for(var S=e[r++],k=0;k<S;k++)o.iconVertexRanges.push([e[r++],e[r++]]);a.push(o)}return r}(s,o,h,u,n.symbols,a),n.bufferDataOffset=u,n}return(0,o.Z)(i,[{key:"hasData",value:function(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}},{key:"triangleCount",value:function(){var e,t=0,i=(0,s.Z)(this.iconPerPageElementsMap);try{for(i.s();!(e=i.n()).done;){var r=(0,n.Z)(e.value,2);r[0];t+=r[1][1]}}catch(h){i.e(h)}finally{i.f()}var a,l=(0,s.Z)(this.glyphPerPageElementsMap);try{for(l.s();!(a=l.n()).done;){var o=(0,n.Z)(a.value,2);o[0];t+=o[1][1]}}catch(h){l.e(h)}finally{l.f()}return t/3}},{key:"doDestroy",value:function(){(0,_.pC)(this.iconVertexArrayObject)&&this.iconVertexArrayObject.dispose(),(0,_.pC)(this.iconVertexBuffer)&&this.iconVertexBuffer.dispose(),(0,_.pC)(this.iconOpacityBuffer)&&this.iconOpacityBuffer.dispose(),(0,_.pC)(this.iconIndexBuffer)&&this.iconIndexBuffer.dispose(),this.iconVertexArrayObject=null,this.iconVertexBuffer=null,this.iconOpacityBuffer=null,this.iconIndexBuffer=null,(0,_.pC)(this.textVertexArrayObject)&&this.textVertexArrayObject.dispose(),(0,_.pC)(this.textVertexBuffer)&&this.textVertexBuffer.dispose(),(0,_.pC)(this.textOpacityBuffer)&&this.textOpacityBuffer.dispose(),(0,_.pC)(this.textIndexBuffer)&&this.textIndexBuffer.dispose(),this.textVertexArrayObject=null,this.textVertexBuffer=null,this.textOpacityBuffer=null,this.textIndexBuffer=null,this.memoryUsed=0}},{key:"updateOpacityInfo",value:function(){if(this.opacityChanged){this.opacityChanged=!1;var e=(0,_.Wg)(this.iconOpacity),t=(0,_.Wg)(this.iconOpacityBuffer);e.length>0&&e.byteLength===t.size&&t.setSubData(e,0,0,e.length);var i=(0,_.Wg)(this.textOpacity),r=(0,_.Wg)(this.textOpacityBuffer);i.length>0&&i.byteLength===r.size&&r.setSubData(i,0,0,i.length)}}},{key:"doPrepareForRendering",value:function(e,t,i){var r=new Uint32Array(t),a=new Int32Array(r.buffer),n=r[i++];this.iconVertexBuffer=ie.f.createVertex(e,P.l1.STATIC_DRAW,new Int32Array(a.buffer,4*i,n)),i+=n;var s=r[i++];this.iconIndexBuffer=ie.f.createIndex(e,P.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*i,s)),i+=s;var l=r[i++];this.textVertexBuffer=ie.f.createVertex(e,P.l1.STATIC_DRAW,new Int32Array(a.buffer,4*i,l)),i+=l;var o=r[i++];this.textIndexBuffer=ie.f.createIndex(e,P.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*i,o)),i+=o,this.iconOpacityBuffer=ie.f.createVertex(e,P.l1.STATIC_DRAW,(0,_.Wg)(this.iconOpacity).buffer),this.textOpacityBuffer=ie.f.createVertex(e,P.l1.STATIC_DRAW,(0,_.Wg)(this.textOpacity).buffer);var h=this.layer,u=h.iconMaterial,c=h.textMaterial;this.iconVertexArrayObject=new re.U(e,u.getAttributeLocations(),u.getLayoutInfo(),{geometry:this.iconVertexBuffer,opacity:this.iconOpacityBuffer},this.iconIndexBuffer),this.textVertexArrayObject=new re.U(e,c.getAttributeLocations(),c.getLayoutInfo(),{geometry:this.textVertexBuffer,opacity:this.textOpacityBuffer},this.textIndexBuffer)}}]),i}(ae),oe=function(e){(0,c.Z)(i,e);var t=(0,f.Z)(i);function i(e,r){var a;(0,l.Z)(this,i),(a=t.call(this,e,r)).type=C.al.CIRCLE,a.circleIndexStart=0,a.circleIndexCount=0;var n=new Uint32Array(e),s=a.bufferDataOffset;return a.circleIndexStart=n[s++],a.circleIndexCount=n[s++],a.bufferDataOffset=s,a}return(0,o.Z)(i,[{key:"hasData",value:function(){return this.circleIndexCount>0}},{key:"triangleCount",value:function(){return this.circleIndexCount/3}},{key:"doDestroy",value:function(){(0,_.pC)(this.circleVertexArrayObject)&&this.circleVertexArrayObject.dispose(),(0,_.pC)(this.circleVertexBuffer)&&this.circleVertexBuffer.dispose(),(0,_.pC)(this.circleIndexBuffer)&&this.circleIndexBuffer.dispose(),this.circleVertexArrayObject=null,this.circleVertexBuffer=null,this.circleIndexBuffer=null,this.memoryUsed=0}},{key:"doPrepareForRendering",value:function(e,t,i){var r=new Uint32Array(t),a=new Int32Array(r.buffer),n=r[i++];this.circleVertexBuffer=ie.f.createVertex(e,P.l1.STATIC_DRAW,new Int32Array(a.buffer,4*i,n)),i+=n;var s=r[i++];this.circleIndexBuffer=ie.f.createIndex(e,P.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*i,s)),i+=s;var l=this.layer.circleMaterial;this.circleVertexArrayObject=new re.U(e,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:this.circleVertexBuffer},this.circleIndexBuffer)}}]),i}(ae),he=i(46618),ue=i(72900),ce=function(e){(0,c.Z)(i,e);var t=(0,f.Z)(i);function i(e,r,a,n,s,o,h){var u,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;return(0,l.Z)(this,i),(u=t.call(this,e,r,a,n,s,o,4096,4096))._memCache=c,u.type="vector-tile",u._referenced=0,u._hasSymbolBuckets=!1,u._memoryUsedByLayerData=0,u.layerData=new Map,u.layerCount=0,u.status="loading",u.allSymbolsFadingOut=!1,u.lastOpacityUpdate=0,u.symbols=new Map,u.isCoverage=!1,u.neededForCoverage=!1,u.decluttered=!1,u.invalidating=!1,u.parentTile=null,u.childrenTiles=new Set,u._processed=!1,u._referenced=1,u.styleRepository=h,u.id=e.id,u}return(0,o.Z)(i,[{key:"hasSymbolBuckets",get:function(){return this._hasSymbolBuckets}},{key:"isFading",get:function(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<he.nN}},{key:"isHoldingForFade",get:function(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<he.nN)}},{key:"wasRequested",get:function(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}},{key:"setData",value:function(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this.invalidating=!1,this._processed=!0}},{key:"deleteLayerData",value:function(e){var t,i=!1,r=(0,s.Z)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value;if(this.layerData.has(a)){var n=this.layerData.get(a);this._memoryUsedByLayerData-=n.memoryUsed,n.type===C.al.SYMBOL&&this.symbols.has(a)&&(this.symbols.delete(a),i=!0),n.destroy(),this.layerData.delete(a),this.layerCount--}}}catch(l){r.e(l)}finally{r.f()}(0,_.pC)(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData),i&&this.emit("symbols-changed"),this.requestRender()}},{key:"processed",value:function(){return this._processed}},{key:"hasData",value:function(){return this.layerCount>0}},{key:"dispose",value:function(){"unloaded"!==this.status&&(fe.delete(this),i._destroyRenderBuckets(this.layerData),this.layerData=null,this.layerCount=0,this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")}},{key:"release",value:function(){return 0==--this._referenced&&(this.dispose(),this.stage=null,!0)}},{key:"retain",value:function(){++this._referenced}},{key:"referenced",get:function(){return this._referenced}},{key:"memoryUsage",get:function(){return(this._memoryUsedByLayerData+256)/(this._referenced||1)}},{key:"changeDataImpl",value:function(e){var t=!1;if(e){var i=e.bucketsWithData,r=e.emptyBuckets,a=this._createRenderBuckets(i);if(r&&r.byteLength>0){var l,o=new Uint32Array(r),h=(0,s.Z)(o);try{for(h.s();!(l=h.n()).done;){var u=l.value;this._deleteLayerData(u)}}catch(b){h.e(b)}finally{h.f()}}var c,f=(0,s.Z)(a);try{for(f.s();!(c=f.n()).done;){var y=(0,n.Z)(c.value,2),d=y[0],v=y[1];this._deleteLayerData(d),v.type===C.al.SYMBOL&&(this.symbols.set(d,v.symbols),t=!0),this._memoryUsedByLayerData+=v.memoryUsed,this.layerData.set(d,v),this.layerCount++}}catch(b){f.e(b)}finally{f.f()}(0,_.pC)(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData)}this._hasSymbolBuckets=!1;var p,g=(0,s.Z)(this.layerData);try{for(g.s();!(p=g.n()).done;){var m=(0,n.Z)(p.value,2);m[0];m[1].type===C.al.SYMBOL&&(this._hasSymbolBuckets=!0)}}catch(b){g.e(b)}finally{g.f()}t&&this.emit("symbols-changed")}},{key:"attachWithContext",value:function(e){this.stage={context:e,trashDisplayObject:function(e){e.processDetach()},untrashDisplayObject:function(){return!1}}}},{key:"setTransform",value:function(e){(0,h.Z)((0,u.Z)(i.prototype),"setTransform",this).call(this,e);var t=this.resolution/(e.resolution*e.pixelRatio),r=this.width/this.rangeX*t,a=this.height/this.rangeY*t,n=[0,0];e.toScreen(n,[this.x,this.y]);var s=this.transforms.tileUnitsToPixels;(0,G.g)(s),(0,G.h)(s,s,n),(0,G.r)(s,s,Math.PI*e.rotation/180),(0,G.d)(s,s,[r,a,1])}},{key:"_createTransforms",value:function(){return{dvs:(0,Y.c)(),tileMat3:(0,Y.c)(),tileUnitsToPixels:(0,Y.c)()}}},{key:"_createRenderBuckets",value:function(e){var t,i=new Map,r=new Map,a=(0,s.Z)(e);try{for(a.s();!(t=a.n()).done;){var n,l=t.value,o=this._deserializeBucket(l,r),h=(0,s.Z)(o.layerUIDs);try{for(h.s();!(n=h.n()).done;){var u=n.value;i.set(u,o)}}catch(c){h.e(c)}finally{h.f()}}}catch(c){a.e(c)}finally{a.f()}return i}},{key:"_deserializeBucket",value:function(e,t){var i=t.get(e);if(i)return i;switch(new Uint32Array(e)[0]){case C.al.FILL:i=new se(e,this.styleRepository);break;case C.al.LINE:i=new ne(e,this.styleRepository);break;case C.al.SYMBOL:i=new le(e,this.styleRepository,this);break;case C.al.CIRCLE:i=new oe(e,this.styleRepository)}return t.set(e,i),i}},{key:"_deleteLayerData",value:function(e){if(this.layerData.has(e)){var t=this.layerData.get(e);this._memoryUsedByLayerData-=t.memoryUsed,t.destroy(),this.layerData.delete(e),this.layerCount--}}}],[{key:"_destroyRenderBuckets",value:function(e){if(e){var t=new Set;e.forEach((function(e){t.has(e)||(e.destroy(),t.add(e))})),e.clear()}}}]),i}(ue.I),fe=new Map;var ye=i(91505),de=i(21391);function ve(e,t,i,r,a,l){var o,h=r.iconRotationAlignment,u=r.textRotationAlignment,c=r.iconTranslate,f=r.iconTranslateAnchor,y=r.textTranslate,d=r.textTranslateAnchor,v=0,p=(0,s.Z)(e.colliders);try{for(p.s();!(o=p.n()).done;){var _=o.value,g=0===_.partIndex?c:y,m=(0,n.Z)(g,2),b=m[0],x=m[1],w=0===_.partIndex?f:d,S=_.minLod<=l&&l<=_.maxLod;v+=S?0:1,_.enabled=S,_.xScreen=_.xTile*a[0]+_.yTile*a[3]+a[6],_.yScreen=_.xTile*a[1]+_.yTile*a[4]+a[7],w===de.fD.MAP?(_.xScreen+=i*b-t*x,_.yScreen+=t*b+i*x):(_.xScreen+=b,_.yScreen+=x),de.aF.VIEWPORT===(0===_.partIndex?h:u)?(_.dxScreen=_.dxPixels,_.dyScreen=_.dyPixels):(_.dxScreen=i*(_.dxPixels+_.width/2)-t*(_.dyPixels+_.height/2)-_.width/2,_.dyScreen=t*(_.dxPixels+_.width/2)+i*(_.dyPixels+_.height/2)-_.height/2)}}catch(k){p.e(k)}finally{p.f()}e.colliders.length>0&&v===e.colliders.length&&(e.unique.show=!1)}var pe=function(){function e(t,i,r,a,n,o){(0,l.Z)(this,e),this._symbols=t,this._styleRepository=a,this._zoom=n,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new ee(i,r,he.PF),this._si=Math.sin(Math.PI*o/180),this._co=Math.cos(Math.PI*o/180);var h,u=(0,s.Z)(t);try{for(u.s();!(h=u.n()).done;){var c,f=h.value,y=(0,s.Z)(f.symbols);try{for(y.s();!(c=y.n()).done;){var d=c.value;this._allNeededMatrices.has(d.tile)||this._allNeededMatrices.set(d.tile,(0,Y.a)(d.tile.transforms.tileUnitsToPixels))}}catch(v){y.e(v)}finally{y.f()}}}catch(v){u.e(v)}finally{u.f()}}return(0,o.Z)(e,[{key:"work",value:function(e){var t=this._gridIndex;function i(e){for(var i=e.xScreen+e.dxScreen,r=e.yScreen+e.dyScreen,a=i+e.width,l=r+e.height,o=t.getCellSpan(i,r,a,l),h=(0,n.Z)(o,4),u=h[0],c=h[1],f=h[2],y=h[3],d=c;d<=y;d++)for(var v=u;v<=f;v++){var p,_=t.cells[d][v],g=(0,s.Z)(_);try{for(g.s();!(p=g.n()).done;){var m=p.value,b=m.xScreen+m.dxScreen,x=m.yScreen+m.dyScreen,w=b+m.width,S=x+m.height;if(!(a<b||i>w||l<x||r>S))return!0}}catch(k){g.e(k)}finally{g.f()}}return!1}for(var r=performance.now();this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0)for(var a=this._symbols[this._currentLayerCursor],l=this._getProperties(a.styleLayerUID);this._currentSymbolCursor<a.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-r>e)return!1;var o=a.symbols[this._currentSymbolCursor];if(o.unique.show){ve(o,this._si,this._co,l,this._allNeededMatrices.get(o.tile),this._zoom);var h=o.unique;if(h.show){var u,c=l.iconAllowOverlap,f=l.iconIgnorePlacement,y=l.textAllowOverlap,d=l.textIgnorePlacement,v=(0,s.Z)(o.colliders);try{for(v.s();!(u=v.n()).done;){var p=u.value;if(p.enabled){var _=h.parts[p.partIndex];_.show&&!(p.partIndex?y:c)&&i(p)&&(p.hard?h.show=!1:_.show=!1)}}}catch(M){v.e(M)}finally{v.f()}if(h.show){var g,m=(0,s.Z)(o.colliders);try{for(m.s();!(g=m.n()).done;){var b=g.value;if(b.enabled&&(!(b.partIndex?d:f)&&h.parts[b.partIndex].show))for(var x=b.xScreen+b.dxScreen,w=b.yScreen+b.dyScreen,S=x+b.width,k=w+b.height,C=this._gridIndex.getCellSpan(x,w,S,k),Z=(0,n.Z)(C,4),T=Z[0],I=Z[1],D=Z[2],R=Z[3],P=I;P<=R;P++)for(var A=T;A<=D;A++)this._gridIndex.cells[P][A].push(b)}}catch(M){m.e(M)}finally{m.f()}}}}}return!0}},{key:"_getProperties",value:function(e){var t=this._styleProps.get(e);if(t)return t;var i=this._zoom,r=this._styleRepository.getStyleLayerByUID(e),a=r.getLayoutValue("symbol-placement",i)!==de.R.POINT,n=r.getLayoutValue("icon-rotation-alignment",i);n===de.aF.AUTO&&(n=a?de.aF.MAP:de.aF.VIEWPORT);var s=r.getLayoutValue("text-rotation-alignment",i);s===de.aF.AUTO&&(s=a?de.aF.MAP:de.aF.VIEWPORT);var l=r.getPaintValue("icon-translate",i),o=r.getPaintValue("icon-translate-anchor",i),h=r.getPaintValue("text-translate",i),u=r.getPaintValue("text-translate-anchor",i),c={iconAllowOverlap:r.getLayoutValue("icon-allow-overlap",i),iconIgnorePlacement:r.getLayoutValue("icon-ignore-placement",i),textAllowOverlap:r.getLayoutValue("text-allow-overlap",i),textIgnorePlacement:r.getLayoutValue("text-ignore-placement",i),iconRotationAlignment:n,textRotationAlignment:s,iconTranslateAnchor:o,iconTranslate:l,textTranslateAnchor:u,textTranslate:h};return this._styleProps.set(e,c),c}}]),e}();function _e(e,t){if(e.priority-t.priority)return e.priority-t.priority;var i=e.tile.key,r=t.tile.key;return i.world-r.world?i.world-r.world:i.level-r.level?i.level-r.level:i.row-r.row?i.row-r.row:i.col-r.col?i.col-r.col:e.xTile-t.xTile?e.xTile-t.xTile:e.yTile-t.yTile}var ge=function(){function e(t,i,r,a,n,s){(0,l.Z)(this,e),this._visibleTiles=t,this._symbolRepository=i,this._createCollisionJob=r,this._assignTileSymbolsOpacity=a,this._symbolLayerSorter=n,this._isLayerVisible=s,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}return(0,o.Z)(e,[{key:"running",get:function(){return this._running}},{key:"setScreenSize",value:function(e,t){this._screenWidth===e&&this._screenHeight===t||this.restart(),this._screenWidth=e,this._screenHeight=t}},{key:"restart",value:function(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}},{key:"continue",value:function(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){var t=performance.now();if(!this._selectionJob.work(e))return!1;if(this._selectionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){var i=performance.now();if(!this._collisionJob.work(e))return!1;if(this._collisionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-i))))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){var r=performance.now();if(!this._opacityJob.work(e))return!1;if(this._opacityJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-r))))return!1}return this._running=!1,!0}},{key:"_createSelectionJob",value:function(){for(var e=this._symbolRepository.uniqueSymbols,t=0;t<e.length;t++)for(var i=e[t],r=0;r<i.uniqueSymbols.length;r++){var a,n=i.uniqueSymbols[r],l=(0,s.Z)(n.tileSymbols);try{for(l.s();!(a=l.n()).done;){a.value.selectedForRendering=!1}}catch(y){l.e(y)}finally{l.f()}}var o=[],h=0,u=0,c=this._isLayerVisible;var f=this._symbolLayerSorter;return{work:function(t){for(var i,r=performance.now();u<e.length;u++,h=0){var a=e[u],n=a.styleLayerUID;if(c(n)){o[u]=o[u]||{styleLayerUID:n,symbols:[]};for(var l=o[u];h<a.uniqueSymbols.length;h++){if(i=a.uniqueSymbols[h],h%100==99&&performance.now()-r>t)return!1;var f,d=null,v=!1,p=!1,_=(0,s.Z)(i.tileSymbols);try{for(_.s();!(f=_.n()).done;){var g=f.value;if(!p||!v){var m=g.tile;(!d||m.isCoverage||m.neededForCoverage&&!v)&&(d=g,(m.neededForCoverage||m.isCoverage)&&(p=!0),m.isCoverage&&(v=!0))}}}catch(y){_.e(y)}finally{_.f()}if(d.selectedForRendering=!0,p){l.symbols.push(d),i.show=!0;var b,x=(0,s.Z)(i.parts);try{for(x.s();!(b=x.n()).done;){b.value.show=!0}}catch(y){x.e(y)}finally{x.f()}}else i.show=!1}}else o[u]||(o[u]={styleLayerUID:n,symbols:[]})}var w,S=(0,s.Z)(o);try{for(S.s();!(w=S.n()).done;){w.value.symbols.sort(_e)}}catch(y){S.e(y)}finally{S.f()}return!0},get sortedSymbols(){return o.sort(f)}}}},{key:"_createOpacityJob",value:function(){var e=this._assignTileSymbolsOpacity,t=this._visibleTiles,i=0;function r(t,i){var a,l=t.symbols,o=(0,s.Z)(l);try{for(o.s();!(a=o.n()).done;){var h=(0,n.Z)(a.value,2);h[0];me(h[1],i)}}catch(f){o.e(f)}finally{o.f()}e(t,i);var u,c=(0,s.Z)(t.childrenTiles);try{for(c.s();!(u=c.n()).done;){r(u.value,i)}}catch(f){c.e(f)}finally{c.f()}}return{work:function(e){for(var a=performance.now();i<t.length;i++){if(performance.now()-a>e)return!1;var n=t[i];(0,_.pC)(n.parentTile)||r(n,performance.now())}return!0}}}}]),e}();function me(e,t){var i,r=(0,s.Z)(e);try{for(r.s();!(i=r.n()).done;){var a,n=i.value.unique,l=(0,s.Z)(n.parts);try{for(l.s();!(a=l.n()).done;){var o=a.value,h=o.targetOpacity>.5?1:-1;o.startOpacity+=h*((t-o.startTime)/he.nN),o.startOpacity=Math.min(Math.max(o.startOpacity,0),1),o.startTime=t,o.targetOpacity=n.show&&o.show?1:0}}catch(u){l.e(u)}finally{l.f()}}}catch(u){r.e(u)}finally{r.f()}}var be=function(){function e(t,i,r){(0,l.Z)(this,e),this.tileCoordRange=t,this._visibleTiles=i,this._createUnique=r,this._tiles=new Map,this._uniqueSymbolsReferences=new Map}return(0,o.Z)(e,[{key:"uniqueSymbols",get:function(){return(0,_.Wi)(this._uniqueSymbolLayerArray)&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}},{key:"add",value:function(e,t){this._uniqueSymbolLayerArray=null;var i=this._tiles.get(e.id);i||(i={symbols:new Map},this._tiles.set(e.id,i));var r=new Map;if(t){var a,l=(0,s.Z)(t);try{for(l.s();!(a=l.n()).done;){var o=a.value;i.symbols.has(o)&&(r.set(o,i.symbols.get(o)),i.symbols.delete(o))}}catch(Z){l.e(Z)}finally{l.f()}}else{var h,u=(0,s.Z)(e.layerData);try{for(u.s();!(h=u.n()).done;){var c=(0,n.Z)(h.value,2),f=c[0];c[1];i.symbols.has(f)&&(r.set(f,i.symbols.get(f)),i.symbols.delete(f))}}catch(Z){u.e(Z)}finally{u.f()}}this._removeSymbols(r);var y,d=e.symbols,v=new Map,p=(0,s.Z)(d);try{for(p.s();!(y=p.n()).done;){var _=(0,n.Z)(y.value,2),g=_[0],m=_[1],b=m.length;if(b>=32){var x=this.tileCoordRange;do{x/=2,b/=4}while(b>8&&x>64);var w=new ee(this.tileCoordRange,this.tileCoordRange,x);v.set(g,{flat:m,index:w}),i.symbols.set(g,{flat:m,index:w});var S,k=(0,s.Z)(m);try{for(k.s();!(S=k.n()).done;){var C=S.value;w.getCell(C.xTile,C.yTile).push(C)}}catch(Z){k.e(Z)}finally{k.f()}}else v.set(g,{flat:m}),i.symbols.set(g,{flat:m})}}catch(Z){p.e(Z)}finally{p.f()}this._addSymbols(e.key,d)}},{key:"deleteStyleLayers",value:function(e){this._uniqueSymbolLayerArray=null;var t,i=(0,s.Z)(this._tiles);try{for(i.s();!(t=i.n()).done;){var r,a=(0,n.Z)(t.value,2),l=a[0],o=a[1],h=new Map,u=(0,s.Z)(e);try{for(u.s();!(r=u.n()).done;){var c=r.value;o.symbols.has(c)&&(h.set(c,o.symbols.get(c)),o.symbols.delete(c))}}catch(f){u.e(f)}finally{u.f()}this._removeSymbols(h),0===o.symbols.size&&this._tiles.delete(l)}}catch(f){i.e(f)}finally{i.f()}}},{key:"removeTile",value:function(e){this._uniqueSymbolLayerArray=null;var t=this._tiles.get(e.id);if(t){var i,r=new Map,a=(0,s.Z)(e.symbols);try{for(a.s();!(i=a.n()).done;){var l=(0,n.Z)(i.value,2),o=l[0];l[1];t.symbols.has(o)&&(r.set(o,t.symbols.get(o)),t.symbols.delete(o))}}catch(h){a.e(h)}finally{a.f()}this._removeSymbols(r),0===t.symbols.size&&this._tiles.delete(e.id)}}},{key:"_removeSymbols",value:function(e){var t,i=(0,s.Z)(e);try{for(i.s();!(t=i.n()).done;){var r,a=(0,n.Z)(t.value,2),l=a[0],o=a[1].flat,h=(0,s.Z)(o);try{for(h.s();!(r=h.n()).done;){for(var u=r.value,c=u.unique,f=c.tileSymbols,y=f.length-1,d=0;d<y;d++)if(f[d]===u){f[d]=f[y];break}if(f.length=y,0===y){var v=this._uniqueSymbolsReferences.get(l);v.delete(c),0===v.size&&this._uniqueSymbolsReferences.delete(l)}u.unique=null}}catch(p){h.e(p)}finally{h.f()}}}catch(p){i.e(p)}finally{i.f()}}},{key:"_addSymbols",value:function(e,t){if(0!==t.size){var i,r=this._visibleTiles,a=(0,s.Z)(r);try{for(a.s();!(i=a.n()).done;){var l=i.value;l.parentTile||l.key.world!==e.world||l.key.level===e.level&&!l.key.equals(e)||this._matchSymbols(l,e,t)}}catch(m){a.e(m)}finally{a.f()}var o,h=(0,s.Z)(t);try{for(h.s();!(o=h.n()).done;){var u,c=(0,n.Z)(o.value,2),f=c[0],y=c[1],d=(0,s.Z)(y);try{for(d.s();!(u=d.n()).done;){var v=u.value;if((0,_.Wi)(v.unique)){var p=this._createUnique();v.unique=p,p.tileSymbols.push(v);var g=this._uniqueSymbolsReferences.get(f);g||(g=new Set,this._uniqueSymbolsReferences.set(f,g)),g.add(p)}}}catch(m){d.e(m)}finally{d.f()}}}catch(m){h.e(m)}finally{h.f()}}}},{key:"_matchSymbols",value:function(e,t,i){if(e.key.level>t.level){var r=e.key.level-t.level;if(e.key.row>>r!==t.row||e.key.col>>r!==t.col)return}if(t.level>e.key.level){var a=t.level-e.key.level;if(t.row>>a!==e.key.row||t.col>>a!==e.key.col)return}if(t.equals(e.key)){var l,o=(0,s.Z)(e.childrenTiles);try{for(o.s();!(l=o.n()).done;){var h=l.value;this._matchSymbols(h,t,i)}}catch(q){o.e(q)}finally{o.f()}}else{var u,c=new Map,f=(0,s.Z)(i);try{for(f.s();!(u=f.n()).done;){var y,d=(0,n.Z)(u.value,2),v=d[0],p=d[1],g=[],m=(0,s.Z)(p);try{for(m.s();!(y=m.n()).done;){var b=y.value,x=$(this.tileCoordRange,b.xTile,t.level,t.col,e.key.level,e.key.col),w=$(this.tileCoordRange,b.yTile,t.level,t.row,e.key.level,e.key.row);x>=0&&x<this.tileCoordRange&&w>=0&&w<this.tileCoordRange&&g.push({symbol:b,xTransformed:x,yTransformed:w})}}catch(q){m.e(q)}finally{m.f()}var S=[],k=e.key.level<t.level?1:1<<e.key.level-t.level,C=this._tiles.get(e.id).symbols.get(v);if(C){var Z,T=C.flat,I=(0,s.Z)(g);try{for(I.s();!(Z=I.n()).done;){var D,R=Z.value,P=!1,A=R.xTransformed,M=R.yTransformed;D=(0,_.pC)(C.index)?C.index.getCell(A,M):T;var L,B=R.symbol,O=B.hash,U=(0,s.Z)(D);try{for(U.s();!(L=U.n()).done;){var V=L.value;if(O===V.hash&&Math.abs(A-V.xTile)<=k&&Math.abs(M-V.yTile)<=k){var F=V.unique;B.unique=F,F.tileSymbols.push(B),P=!0;break}}}catch(q){U.e(q)}finally{U.f()}P||S.push(B)}}catch(q){I.e(q)}finally{I.f()}}S.length>0&&c.set(v,S)}}catch(q){f.e(q)}finally{f.f()}var E,z=(0,s.Z)(e.childrenTiles);try{for(z.s();!(E=z.n()).done;){var H=E.value;this._matchSymbols(H,t,c)}}catch(q){z.e(q)}finally{z.f()}}}},{key:"_createUniqueSymbolLayerArray",value:function(){var e,t,i=this._uniqueSymbolsReferences,r=new Array(i.size),a=0,l=(0,s.Z)(i);try{for(l.s();!(t=l.n()).done;){var o=(0,n.Z)(t.value,2),h=o[0],u=o[1],c=new Array(u.size);e=0;var f,y=(0,s.Z)(u);try{for(y.s();!(f=y.n()).done;){var d=f.value;c[e++]=d}}catch(v){y.e(v)}finally{y.f()}r[a]={styleLayerUID:h,uniqueSymbols:c},a++}}catch(v){l.e(v)}finally{l.f()}return r}}]),e}(),xe=1e-6,we=function(e){(0,c.Z)(i,e);var t=(0,f.Z)(i);function i(e,r){var a;return(0,l.Z)(this,i),(a=t.call(this)).styleRepository=e,a._tileToHandle=new Map,a._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},a._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},a._completed=!1,a._symbolRepository=new be(4096,r,(function(){return new X})),a._symbolDeclutterer=new ge(r,a._symbolRepository,(function(e,t,i){return new pe(e,t,i,a.styleRepository,a._zoom,a._viewState.rotation)}),(function(e,t){e.allSymbolsFadingOut=!0,e.lastOpacityUpdate=t,function(e,t,i){var r,a=(0,s.Z)(e.symbols);try{for(a.s();!(r=a.n()).done;){var l=(0,n.Z)(r.value,2),o=l[0];te(e,t,i,l[1],o)}}catch(h){a.e(h)}finally{a.f()}}(e,t,!0),e.decluttered=!0,e.requestRender()}),(function(e,t){return a.styleRepository.getStyleLayerByUID(e.styleLayerUID).z-a.styleRepository.getStyleLayerByUID(t.styleLayerUID).z}),(function(e){var t=a.styleRepository.getStyleLayerByUID(e);if(a._zoom+xe<t.minzoom||a._zoom-xe>=t.maxzoom)return!1;var i=t.getLayoutProperty("visibility");return!i||i.getValue()!==de.EE.NONE})),a}return(0,o.Z)(i,[{key:"addTile",value:function(e){var t=this;e.decluttered=!1,this._tileToHandle.set(e,e.on("symbols-changed",(function(){t._symbolRepository.add(e),t.restartDeclutter()}))),this._symbolRepository.add(e),this.restartDeclutter()}},{key:"removeTile",value:function(e){var t=this._tileToHandle.get(e);t&&(this._symbolRepository.removeTile(e),this.restartDeclutter(),t.remove(),this._tileToHandle.delete(e))}},{key:"update",value:function(e,t){return this._zoom=e,this._viewState={scale:t.scale,rotation:t.rotation,center:[t.center[0],t.center[1]],size:[t.size[0],t.size[1]]},this._continueDeclutter(),this._completed}},{key:"restartDeclutter",value:function(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}},{key:"clear",value:function(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach((function(e){return e.remove()})),this._tileToHandle.clear()}},{key:"stale",get:function(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}},{key:"deleteStyleLayers",value:function(e){this._symbolRepository.deleteStyleLayers(e)}},{key:"_continueDeclutter",value:function(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(he.Ts),this._completed&&this._scheduleNotifyStable())}},{key:"_scheduleNotifyStable",value:function(){var e=this;(0,_.pC)(this._stableNotificationHandle)&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout((function(){e._stableNotificationHandle=null,e.emit("fade-complete")}),1.5*he.nN)}},{key:"_notifyUnstable",value:function(){(0,_.pC)(this._stableNotificationHandle)&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this.emit("fade-start")}}]),i}(ye.Z),Se=i(80613),ke=function(e){(0,c.Z)(i,e);var t=(0,f.Z)(i);function i(){return(0,l.Z)(this,i),t.apply(this,arguments)}return(0,o.Z)(i,[{key:"_createTransforms",value:function(){return{dvs:(0,Y.c)(),tileMat3:(0,Y.c)()}}}]),i}(ue.I),Ce=i(55067),Ze=1e-6;function Te(e,t){if(e){var i=e.getLayoutProperty("visibility");if(!i||i.getValue()!==de.EE.NONE&&(void 0===e.minzoom||e.minzoom<t+Ze)&&(void 0===e.maxzoom||e.maxzoom>=t-Ze))return!0}return!1}var Ie=function(e){(0,c.Z)(i,e);var t=(0,f.Z)(i);function i(e){var r;return(0,l.Z)(this,i),(r=t.call(this,e))._backgroundTiles=[],r._pointToCallbacks=new Map,r}return(0,o.Z)(i,[{key:"destroy",value:function(){this.removeAllChildren(),this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null),(0,_.pC)(this._symbolFader)&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[],this._pointToCallbacks.clear()}},{key:"setStyleResources",value:function(e,t,i){var r=this;if(this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=i,(0,_.Wi)(this._symbolFader)){var a=new we(this._styleRepository,this.children);a.on("fade-start",(function(){r.emit("fade-start"),r.requestRender()})),a.on("fade-complete",(function(){r.emit("fade-complete"),r.requestRender()})),this._symbolFader=a}(0,_.Wg)(this._symbolFader).styleRepository=i}},{key:"setSpriteMosaic",value:function(e){this._spriteMosaic.dispose(),this._spriteMosaic=e}},{key:"deleteStyleLayers",value:function(e){(0,_.pC)(this._symbolFader)&&this._symbolFader.deleteStyleLayers(e)}},{key:"hitTest",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t){var i;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=(0,g.hh)(),e.abrupt("return",(this._pointToCallbacks.set(t,i),this.requestRender(),i.promise));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"enterTileInvalidation",value:function(){var e,t=(0,s.Z)(this.children);try{for(t.s();!(e=t.n()).done;){e.value.invalidating=!0}}catch(i){t.e(i)}finally{t.f()}}},{key:"createRenderParams",value:function(e){return(0,Z.Z)((0,Z.Z)({},(0,h.Z)((0,u.Z)(i.prototype),"createRenderParams",this).call(this,e)),{},{renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos})}},{key:"doRender",value:function(e){!this.visible||e.drawPhase!==Se.jx.MAP&&e.drawPhase!==Se.jx.DEBUG||void 0===this._spriteMosaic||(0,h.Z)((0,u.Z)(i.prototype),"doRender",this).call(this,e)}},{key:"addChild",value:function(e){return(0,h.Z)((0,u.Z)(i.prototype),"addChild",this).call(this,e),(0,_.pC)(this._symbolFader)?this._symbolFader.addTile(e):e.decluttered=!0,this.requestRender(),e}},{key:"removeChild",value:function(e){return(0,_.pC)(this._symbolFader)&&this._symbolFader.removeTile(e),this.requestRender(),(0,h.Z)((0,u.Z)(i.prototype),"removeChild",this).call(this,e)}},{key:"renderChildren",value:function(e){var t=e.drawPhase;if(t!==Se.jx.DEBUG){if(this._doRender(e),this._pointToCallbacks.size>0){e.drawPhase=Se.jx.HITTEST;var r=e.painter.effects.hittestVTL;r.bind(e),this._doRender(e),r.draw(e,this._pointToCallbacks),r.unbind(e),e.drawPhase=t}}else(0,h.Z)((0,u.Z)(i.prototype),"renderChildren",this).call(this,e)}},{key:"removeAllChildren",value:function(){for(var e=0;e<this.children.length;e++){var t=this.children[e];(0,_.pC)(this._symbolFader)&&this._symbolFader.removeTile(t),t.dispose()}(0,h.Z)((0,u.Z)(i.prototype),"removeAllChildren",this).call(this)}},{key:"getStencilTarget",value:function(){return this.children.filter((function(e){return e.neededForCoverage&&e.hasData()}))}},{key:"restartDeclutter",value:function(){(0,_.pC)(this._symbolFader)&&this._symbolFader.restartDeclutter()}},{key:"_doRender",value:function(e){var t=e.context,r=this._styleRepository;if(r){var a=r.layers,n=!0;e.drawPhase===Se.jx.HITTEST&&(n=!1),r.backgroundBucketIds.length>0&&(e.renderPass="background",this._renderBackgroundLayers(e,r.backgroundBucketIds)),(0,h.Z)((0,u.Z)(i.prototype),"renderChildren",this).call(this,e),e.drawPhase===Se.jx.MAP&&this._fade(e.displayLevel,e.state);var l=this.children.filter((function(e){return e.visible&&e.hasData()}));if(!l||0===l.length)return t.bindVAO(),t.setStencilTestEnabled(!0),void t.setBlendingEnabled(!0);var o,c=(0,s.Z)(l);try{for(c.s();!(o=c.n()).done;){o.value.triangleCount=0}}catch(d){c.e(d)}finally{c.f()}t.setStencilWriteMask(0),t.setColorMask(!0,!0,!0,!0),t.setStencilOp(P.xS.KEEP,P.xS.KEEP,P.xS.REPLACE),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!1),t.setDepthTestEnabled(!0),t.setDepthWriteEnabled(!0),t.setDepthFunction(P.wb.LEQUAL),t.setClearDepth(1),t.clear(t.gl.DEPTH_BUFFER_BIT),e.renderPass="opaque";for(var f=a.length-1;f>=0;f--)this._renderStyleLayer(a[f],e,l);t.setDepthWriteEnabled(!1),t.setBlendingEnabled(n),t.setBlendFunctionSeparate(P.zi.ONE,P.zi.ONE_MINUS_SRC_ALPHA,P.zi.ONE,P.zi.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(var y=0;y<a.length;y++)this._renderStyleLayer(a[y],e,l);t.bindVAO(),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!0)}}},{key:"_fade",value:function(e,t){(0,_.pC)(this._symbolFader)&&(this._symbolFader.update(e,t)||this.requestRender())}},{key:"_renderStyleLayer",value:function(e,t,i){var r=t.painter,a=t.renderPass;if(void 0!==e){var n=e.getLayoutProperty("visibility");if(!n||n.getValue()!==de.EE.NONE){var l;switch(e.type){case de.fR.BACKGROUND:return;case de.fR.FILL:if("opaque"!==a&&"translucent"!==t.renderPass)return;l="vtlFill";break;case de.fR.LINE:if("translucent"!==a)return;l="vtlLine";break;case de.fR.CIRCLE:if("translucent"!==a)return;l="vtlCircle";break;case de.fR.SYMBOL:if("translucent"!==a)return;l="vtlSymbol"}if(i=e.type===de.fR.SYMBOL?i.filter((function(e){return e.decluttered})):i.filter((function(e){return e.neededForCoverage})),"vtlSymbol"!==l){var o=t.displayLevel;if(0===i.length||void 0!==e.minzoom&&e.minzoom>=o+Ze||void 0!==e.maxzoom&&e.maxzoom<o-Ze)return}var h=e.uid;t.styleLayerUID=h,t.styleLayer=e;var u,c=(0,s.Z)(i);try{for(c.s();!(u=c.n()).done;){if(u.value.layerData.has(h)){r.renderObjects(t,i,l);break}}}catch(f){c.e(f)}finally{c.f()}}}}},{key:"_renderBackgroundLayers",value:function(e,t){var i,r=e.context,a=e.displayLevel,n=e.painter,l=e.state,o=this._styleRepository,h=!1,u=(0,s.Z)(t);try{for(u.s();!(i=u.n()).done;){var c=i.value;if(o.getLayerById(c).type===de.fR.BACKGROUND&&Te(o.getLayerById(c),a)){h=!0;break}}}catch(E){u.e(E)}finally{u.f()}if(h){var f=this._tileInfoView.getTileCoverage(e.state,0,"smallest"),y=f.spans,d=f.lodInfo,v=d.level,p=(0,S.Ue)(),g=[];if(this._renderPasses){var m=this._renderPasses[0];(0,_.pC)(this._clippingInfos)&&(m.brushes[0].prepareState(e),m.brushes[0].drawMany(e,this._clippingInfos))}var b,x,w=this._backgroundTiles,k=0,C=(0,s.Z)(y);try{for(C.s();!(x=C.n()).done;)for(var Z=x.value,T=Z.row,I=Z.colFrom,D=Z.colTo,R=I;R<=D;R++){if(k<w.length)(b=w[k]).key.set(v,T,d.normalizeCol(R),d.getWorldForColumn(R)),this._tileInfoView.getTileBounds(p,b.key,!1),b.x=p[0],b.y=p[3],b.resolution=this._tileInfoView.getTileResolution(v);else{var A=new H.Z(v,T,d.normalizeCol(R),d.getWorldForColumn(R)),M=this._tileInfoView.getTileBounds((0,S.Ue)(),A),L=this._tileInfoView.getTileResolution(v);b=new ke(A,L,M[0],M[3],512,512,4096,4096),w.push(b)}b.setTransform(l),g.push(b),k++}}catch(E){C.e(E)}finally{C.f()}r.setStencilWriteMask(0),r.setColorMask(!0,!0,!0,!0),r.setStencilOp(P.xS.KEEP,P.xS.KEEP,P.xS.REPLACE),r.setStencilFunction(P.wb.EQUAL,0,255);var B=!0;e.drawPhase===Se.jx.HITTEST&&(B=!1),r.setStencilTestEnabled(B);var O,U=(0,s.Z)(t);try{for(U.s();!(O=U.n()).done;){var V=O.value,F=o.getLayerById(V);F.type===de.fR.BACKGROUND&&Te(F,a)&&(e.styleLayerUID=F.uid,e.styleLayer=F,n.renderObjects(e,g,"vtlBackground"))}}catch(E){U.e(E)}finally{U.f()}W.Z.pool.release(f)}}}]),i}(Ce.Z),De=i(30969),Re=i(95986),Pe=(i(53634),i(63780),i(93169),i(37825),i(49800),i(3667),i(87422)),Ae={geometry:[new(i(61109).G)("a_PositionAndFlags",3,P.g.SHORT,0,6)]},Me=new Map;Me.set("a_PositionAndFlags",0);var Le={vsPath:"debug/overlay",fsPath:"debug/overlay",attributes:Me},Be=function(e){(0,c.Z)(i,e);var t=(0,f.Z)(i);function i(e){var r;return(0,l.Z)(this,i),(r=t.call(this))._conf=e,r}return(0,o.Z)(i,[{key:"_createTransforms",value:function(){return{dvs:(0,Y.c)()}}},{key:"doRender",value:function(e){this._updateTransforms(e),this._ensureResources(e);var t=e.context;t.useProgram(this._program),this._program.setUniformMatrix3fv("u_dvsMat3",this.transforms.dvs),this._program.setUniform4fv("u_colors",this._conf.getColors(e)),this._program.setUniform1fv("u_opacities",this._conf.getOpacities(e));var i=this._conf.getMesh(e),r=i.vertexData,a=i.indexData;this._vertexBuffer.setData(r),this._indexBuffer.setData(a),t.bindVAO(this._vertexArray),t.setBlendingEnabled(!0),t.setBlendFunction(P.zi.ONE,P.zi.ONE_MINUS_SRC_ALPHA),t.setDepthTestEnabled(!1),t.setStencilTestEnabled(!1),t.setColorMask(!0,!0,!0,!0),t.drawElements(P.MX.TRIANGLES,a.length,P.g.UNSIGNED_INT,0)}},{key:"onDetach",value:function(){this._vertexArray&&(this._vertexArray.dispose(),this._vertexArray=null)}},{key:"_updateTransforms",value:function(e){(0,G.g)(this.transforms.dvs),(0,G.h)(this.transforms.dvs,this.transforms.dvs,[-1,1]),(0,G.d)(this.transforms.dvs,this.transforms.dvs,[2/e.state.size[0],-2/e.state.size[1],1])}},{key:"_ensureResources",value:function(e){var t=e.context;this._program||(this._program=e.painter.materialManager.getProgram(Le)),this._vertexBuffer||(this._vertexBuffer=ie.f.createVertex(t,P.l1.STREAM_DRAW)),this._indexBuffer||(this._indexBuffer=ie.f.createIndex(t,P.l1.STREAM_DRAW)),this._vertexArray||(this._vertexArray=new re.U(t,Me,Ae,{geometry:this._vertexBuffer},this._indexBuffer))}}],[{key:"makeFlags",value:function(e,t){return e|t<<2}}]),i}(Pe.s),Oe=i(22824),Ue=function(e){(0,c.Z)(i,e);var t=(0,f.Z)(i);function i(){var e;return(0,l.Z)(this,i),(e=t.apply(this,arguments))._fullCacheLodInfos=null,e._levelByScale={},e}return(0,o.Z)(i,[{key:"getTileParentId",value:function(e){var t=H.Z.pool.acquire(e),i=0===t.level?null:H.Z.getId(t.level-1,t.row>>1,t.col>>1,t.world);return H.Z.pool.release(t),i}},{key:"getTileCoverage",value:function(e,t,r){var a=(0,h.Z)((0,u.Z)(i.prototype),"getTileCoverage",this).call(this,e,t,r);if(!a)return a;var n=1<<a.lodInfo.level;return a.spans=a.spans.filter((function(e){return e.row>=0&&e.row<n})),a}},{key:"scaleToLevel",value:function(e){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[e])return this._levelByScale[e];var t,i,r=this._fullCacheLodInfos;if(e>r[0].scale)return r[0].level;for(var a=0;a<r.length-1;a++)if(e>(i=r[a+1]).scale)return(t=r[a]).level+(t.scale-e)/(t.scale-i.scale);return r[r.length-1].level}},{key:"_initializeFullCacheLODs",value:function(e){var t;if(0===e[0].level)t=e.map((function(e){return{level:e.level,resolution:e.resolution,scale:e.scale}}));else{var i=this.tileInfo.size[0],r=this.tileInfo.spatialReference;t=Oe.Z.create({size:i,spatialReference:r}).lods.map((function(e){return{level:e.level,resolution:e.resolution,scale:e.scale}}))}for(var a=0;a<t.length;a++)this._levelByScale[t[a].scale]=t[a].level;this._fullCacheLodInfos=t}}]),i}(i(37995).Z),Ve=i(32344),Fe=i(67581),Ee=function(e){(0,c.Z)(i,e);var t=(0,f.Z)(i);function i(){var e;return(0,l.Z)(this,i),(e=t.apply(this,arguments))._styleChanges=[],e._fetchQueue=null,e._parseQueue=null,e._isTileHandlerReady=!1,e.fading=!1,e._getCollidersMesh=function(t){var i,r=t.state.pixelRatio,a=0,l=[],o=[],h=(0,s.Z)(e._vectorTileContainer.children);try{for(h.s();!(i=h.n()).done;){var u=i.value;if(u.symbols){var c,f=(0,s.Z)(u.symbols);try{for(f.s();!(c=f.n()).done;){var y,d=(0,n.Z)(c.value,2),v=(d[0],d[1]),p=(0,s.Z)(v);try{for(p.s();!(y=p.n()).done;){var _,g=y.value,m=(0,s.Z)(g.colliders);try{for(m.s();!(_=m.n()).done;){var b=_.value,x=(b.xScreen+b.dxScreen)*r,w=(b.yScreen+b.dyScreen)*r,S=b.width*r,k=b.height*r,C=g.unique.parts[b.partIndex].targetOpacity>.5;if(C||"all"===e.layer.showCollisionBoxes){var Z=C?2:0,T=C?3:0,I=Be.makeFlags(Z,T);l.push(x,w,I,x+S,w,I,x,w+k,I,x+S,w+k,I),o.push(a+0,a+1,a+2,a+1,a+3,a+2),a+=4;var D=C?3:1,R=C?3:0,P=Be.makeFlags(D,R);l.push(x,w,P,x+S,w,P,x,w+1,P,x+S,w+1,P),o.push(a+0,a+1,a+2,a+1,a+3,a+2),a+=4,l.push(x,w+k-1,P,x+S,w+k-1,P,x,w+k,P,x+S,w+k,P),o.push(a+0,a+1,a+2,a+1,a+3,a+2),a+=4,l.push(x,w,P,x+1,w,P,x,w+k,P,x+1,w+k,P),o.push(a+0,a+1,a+2,a+1,a+3,a+2),a+=4,l.push(x+S-1,w,P,x+S,w,P,x+S-1,w+k,P,x+S,w+k,P),o.push(a+0,a+1,a+2,a+1,a+3,a+2),a+=4}}}catch(A){m.e(A)}finally{m.f()}}}catch(A){p.e(A)}finally{p.f()}}}catch(A){f.e(A)}finally{f.f()}}}}catch(A){h.e(A)}finally{h.f()}return{vertexData:new Int16Array(l),indexData:new Uint32Array(o)}},e._getCollidersColors=function(){return[1,.5,0,1,1,0,0,1,0,1,.5,1,0,.5,0,1]},e._getCollidersOpacities=function(){return[.05,.01,.15,.2]},e}return(0,o.Z)(i,[{key:"hitTest",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t,i){var a,n,s,l,o;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._tileHandlerPromise){e.next=2;break}return e.abrupt("return",null);case 2:return e.next=4,this._tileHandlerPromise;case 4:return e.next=6,this._vectorTileContainer.hitTest(i);case 6:if((a=e.sent)&&0!==a.length){e.next=9;break}return e.abrupt("return",null);case 9:if(n=a[0]-1,s=this._styleRepository,l=s.getStyleLayerByUID(n)){e.next=12;break}return e.abrupt("return",null);case 12:return o=s.getStyleLayerIndex(l.id),e.abrupt("return",[{type:"graphic",mapPoint:t,layer:this.layer,graphic:new d.Z({attributes:{layerId:o,layerName:l.id,layerUID:n},layer:this.layer,sourceLayer:this.layer})}]);case 14:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"update",value:function(e){if(this._tileHandlerPromise&&this._isTileHandlerReady)return e.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=e.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.state=e.state,this._parseQueue.state=e.state,this._tileManager.update(e)||this.requestUpdate(),this._parseQueue.resume(),this._fetchQueue.resume()))}},{key:"attach",value:function(){var e=this,t=this.layer.currentStyleInfo.style;this._styleRepository=new De.Z(t),this._tileInfoView=new Ue(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new Ie(this._tileInfoView),this._tileHandler=new q(this.layer,this._styleRepository,window.devicePixelRatio||1),this.container.addChild(this._vectorTileContainer),this._start(),this.handles.add([this._vectorTileContainer.on("fade-start",(function(){e.fading=!0,e.notifyChange("updating"),e.requestUpdate()})),this._vectorTileContainer.on("fade-complete",(function(){var t;null!==(t=e._collisionOverlay)&&void 0!==t&&t.requestRender(),e.fading=!1,e.notifyChange("updating"),e.requestUpdate()})),(0,m.YP)((function(){return e.layer.showCollisionBoxes}),(function(t){"none"!==t?e._collisionOverlay||(e._collisionOverlay=new Be({getMesh:e._getCollidersMesh,getColors:e._getCollidersColors,getOpacities:e._getCollidersOpacities}),e.container.addChild(e._collisionOverlay)):(e.container.removeChild(e._collisionOverlay),e._collisionOverlay=null),e.container.requestRender()}),m.nn),this.layer.on("paint-change",(function(t){if(t.isDataDriven)e._styleChanges.push({type:C.Fr.PAINTER_CHANGED,data:t}),e.notifyChange("updating"),e.requestUpdate();else{var i=e._styleRepository,r=i.getLayerById(t.layer);if(!r)return;var a=r.type===de.fR.SYMBOL;i.setPaintProperties(t.layer,t.paint),a&&e._vectorTileContainer.restartDeclutter(),e._vectorTileContainer.requestRender()}})),this.layer.on("layout-change",(function(t){var i=e._styleRepository,r=i.getLayerById(t.layer);if(r){var a=(0,w.Hg)(r.layout,t.layout);if(!(0,_.Wi)(a)){if((0,w.uD)(a,"visibility")&&1===function(e){if((0,_.Wi)(e))return 0;switch(e.type){case"partial":return Object.keys(e.diff).length;case"complete":return Math.max(Object.keys(e.oldValue).length,Object.keys(e.newValue).length);case"collection":return Object.keys(e.added).length+Object.keys(e.changed).length+Object.keys(e.removed).length}}(a))return i.setLayoutProperties(t.layer,t.layout),r.type===de.fR.SYMBOL&&e._vectorTileContainer.restartDeclutter(),void e._vectorTileContainer.requestRender();e._styleChanges.push({type:C.Fr.LAYOUT_CHANGED,data:t}),e.notifyChange("updating"),e.requestUpdate()}}})),this.layer.on("style-layer-visibility-change",(function(t){var i=e._styleRepository,r=i.getLayerById(t.layer);r&&(i.setStyleLayerVisibility(t.layer,t.visibility),r.type===de.fR.SYMBOL&&e._vectorTileContainer.restartDeclutter(),e._vectorTileContainer.requestRender())})),this.layer.on("style-layer-change",(function(t){e._styleChanges.push({type:C.Fr.LAYER_CHANGED,data:t}),e.notifyChange("updating"),e.requestUpdate()})),this.layer.on("delete-style-layer",(function(t){e._styleChanges.push({type:C.Fr.LAYER_REMOVED,data:t}),e.notifyChange("updating"),e.requestUpdate()})),this.layer.on("load-style",(function(){return e._loadStyle()})),this.layer.on("spriteSource-change",(function(t){e._newSpriteSource=t.spriteSource,e._styleChanges.push({type:C.Fr.SPRITES_CHANGED,data:null});var i,r=e._styleRepository.layers,a=(0,s.Z)(r);try{for(a.s();!(i=a.n()).done;){var n=i.value;switch(n.type){case de.fR.SYMBOL:n.getLayoutProperty("icon-image")&&e._styleChanges.push({type:C.Fr.LAYOUT_CHANGED,data:{layer:n.id,layout:n.layout}});break;case de.fR.LINE:n.getPaintProperty("line-pattern")&&e._styleChanges.push({type:C.Fr.PAINTER_CHANGED,data:{layer:n.id,paint:n.paint,isDataDriven:n.isPainterDataDriven()}});break;case de.fR.FILL:n.getLayoutProperty("fill-pattern")&&e._styleChanges.push({type:C.Fr.PAINTER_CHANGED,data:{layer:n.id,paint:n.paint,isDataDriven:n.isPainterDataDriven()}})}}}catch(l){a.e(l)}finally{a.f()}e.notifyChange("updating"),e.requestUpdate()}))],this.declaredClass)}},{key:"detach",value:function(){var e,t;this._stop(),this.container.removeAllChildren(),null!==(e=this._vectorTileContainer)&&void 0!==e&&e.destroy(),this._vectorTileContainer=null,null!==(t=this._tileHandler)&&void 0!==t&&t.destroy(),this._tileHandler=null,this.handles.remove(this.declaredClass)}},{key:"moveStart",value:function(){this.requestUpdate()}},{key:"viewChange",value:function(){this.requestUpdate()}},{key:"moveEnd",value:function(){this._collisionOverlay&&this._vectorTileContainer.restartDeclutter(),this.requestUpdate()}},{key:"supportsSpatialReference",value:function(e){var t;return(0,k.fS)(null===(t=this.layer.tileInfo)||void 0===t?void 0:t.spatialReference,e)}},{key:"canResume",value:function(){var e=(0,h.Z)((0,u.Z)(i.prototype),"canResume",this).call(this),t=this.layer.currentStyleInfo;if(e&&null!==t&&void 0!==t&&t.layerDefinition){var r=this.view.scale,a=t.layerDefinition,n=a.minScale,s=a.maxScale;t&&t.layerDefinition&&(n&&n<r&&(e=!1),s&&s>r&&(e=!1))}return e}},{key:"isUpdating",value:function(){var e=this._vectorTileContainer.children;return!this._isTileHandlerReady||!this._fetchQueue||!this._parseQueue||this._fetchQueue.updating||this._parseQueue.updating||e.length>0&&e.some((function(e){return e.invalidating}))||this.fading}},{key:"acquireTile",value:function(e){var t=this,i=this._createVectorTile(e);return this._tileHandlerPromise.then((function(){t._fetchQueue.push(i.key).then((function(e){return t._parseQueue.push({key:i.key,data:e})})).then((function(e){i.once("attach",(function(){return t.requestUpdate()})),i.setData(e),t.requestUpdate(),t.notifyChange("updating")})).catch((function(e){t.notifyChange("updating"),(0,g.D_)(e)||p.Z.getLogger(t.declaredClass).error(e)}))})),i}},{key:"releaseTile",value:function(e){var t=e.key.id;this._fetchQueue.abort(t),this._parseQueue.abort(t),this.requestUpdate()}},{key:"_start",value:function(){var e=this;if(this._stop(),this._tileManager=new Q({acquireTile:function(t){return e.acquireTile(t)},releaseTile:function(t){return e.releaseTile(t)},tileInfoView:this._tileInfoView},this._vectorTileContainer),this.layer.currentStyleInfo){var t=new AbortController,i=this._tileHandler.start({signal:t.signal}).then((function(){e._fetchQueue=new Ve.Z({tileInfoView:e._tileInfoView,process:function(t,i){return e._getTileData(t,i)},concurrency:15}),e._parseQueue=new Ve.Z({tileInfoView:e._tileInfoView,process:function(t,i){return e._parseTileData(t,i)},concurrency:8}),e.requestUpdate(),e._isTileHandlerReady=!0}));this._tileHandler.spriteMosaic.then((function(t){e._vectorTileContainer.setStyleResources(t,e._tileHandler.glyphMosaic,e._styleRepository),e.requestUpdate()})),this._tileHandlerAbortController=t,this._tileHandlerPromise=i}}},{key:"_stop",value:function(){if(this._tileHandlerAbortController&&this._vectorTileContainer){var e=this._tileHandlerAbortController;e&&e.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue&&(this._fetchQueue.destroy(),this._fetchQueue=null),this._parseQueue&&(this._parseQueue.destroy(),this._parseQueue=null),this._tileManager&&(this._tileManager.destroy(),this._tileManager=null),this._vectorTileContainer.removeAllChildren()}}},{key:"_getTileData",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t,i){var a;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._tileHandler.fetchTileData(t,i);case 2:return a=e.sent,e.abrupt("return",(this.notifyChange("updating"),a));case 4:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_parseTileData",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t,i){return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._tileHandler.parseTileData(t,i));case 1:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_applyStyleChanges",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(){var t,i,a,n,l,o,h,u,c,f,y,d,v=this;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this._tileManager.clearCache(),t=this._styleChanges,e.prev=2,e.next=5,this._tileHandler.updateStyle(t);case 5:e.next=10;break;case 7:e.prev=7,e.t0=e.catch(2),p.Z.getLogger(this.declaredClass).error("error applying vector-tiles style update",e.t0.message),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0;case 10:if(i=this._styleRepository,a=[],t.forEach((function(e){if(e.type===C.Fr.LAYER_REMOVED){var t=e.data,r=i.getLayerById(t.layer);r&&a.push(r.uid)}})),n=[],t.forEach((function(e){var t=e.type,r=e.data;switch(t){case C.Fr.PAINTER_CHANGED:i.setPaintProperties(r.layer,r.paint),l=r.layer;break;case C.Fr.LAYOUT_CHANGED:i.setLayoutProperties(r.layer,r.layout),l=r.layer;break;case C.Fr.LAYER_REMOVED:return void i.deleteStyleLayer(r.layer);case C.Fr.LAYER_CHANGED:i.setStyleLayer(r.layer,r.index),l=r.layer.id;break;case C.Fr.SPRITES_CHANGED:v._vectorTileContainer.setSpriteMosaic(v._tileHandler.setSpriteSource(v._newSpriteSource)),v._newSpriteSource=null,l=null}var a=i.getLayerById(l);a&&n.push(a.uid)})),o=this._vectorTileContainer.children,a.length>0){this._vectorTileContainer.deleteStyleLayers(a),h=(0,s.Z)(o);try{for(h.s();!(u=h.n()).done;)u.value.deleteLayerData(a)}catch(r){h.e(r)}finally{h.f()}}if(this._fetchQueue.resume(),this._parseQueue.resume(),!(n.length>0)){e.next=22;break}c=[],f=(0,s.Z)(o);try{for(d=function(){var e=y.value,t=v._fetchQueue.push(e.key).then((function(t){return v._parseQueue.push({key:e.key,data:t,styleLayerUIDs:n})})).then((function(t){return e.setData(t)}));c.push(t)},f.s();!(y=f.n()).done;)d()}catch(r){f.e(r)}finally{f.f()}return e.next=22,Promise.all(c);case 22:this._styleChanges=[],this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate();case 23:case"end":return e.stop()}}),e,this,[[2,7]])})));return function(){return e.apply(this,arguments)}}()},{key:"_loadStyle",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(){var t,i,a,n;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.layer.currentStyleInfo.style,i=(0,v.d9)(t),this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this.notifyChange("updating"),this._styleRepository=new De.Z(i),this._vectorTileContainer.destroy(),this._tileManager.clear(),this._tileHandlerAbortController.abort(),this._tileHandlerAbortController=new AbortController,a=this._tileHandlerAbortController.signal,e.prev=3,this._tileHandlerPromise=this._tileHandler.setStyle(this._styleRepository,i),e.next=7,this._tileHandlerPromise;case 7:e.next=13;break;case 9:if(e.prev=9,e.t0=e.catch(3),(0,g.D_)(e.t0)){e.next=13;break}throw e.t0;case 13:if(!a.aborted){e.next=15;break}return e.abrupt("return",(this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),void this.requestUpdate()));case 15:return e.next=17,this._tileHandler.spriteMosaic;case 17:n=e.sent,this._vectorTileContainer.setStyleResources(n,this._tileHandler.glyphMosaic,this._styleRepository),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate();case 19:case"end":return e.stop()}}),e,this,[[3,9]])})));return function(){return e.apply(this,arguments)}}()},{key:"_createVectorTile",value:function(e){var t=this._tileInfoView.getTileBounds((0,S.Ue)(),e),i=this._tileInfoView.getTileResolution(e.level);return new ce(e,i,t[0],t[3],512,512,this._styleRepository)}}]),i}((0,Re.y)(Fe.Z));(0,y._)([(0,b.Cb)()],Ee.prototype,"_fetchQueue",void 0),(0,y._)([(0,b.Cb)()],Ee.prototype,"_parseQueue",void 0),(0,y._)([(0,b.Cb)()],Ee.prototype,"_isTileHandlerReady",void 0),(0,y._)([(0,b.Cb)()],Ee.prototype,"fading",void 0);var ze=Ee=(0,y._)([(0,x.j)("esri.views.2d.layers.VectorTileLayerView2D")],Ee)}}]);
//# sourceMappingURL=7200.5145259f.chunk.js.map